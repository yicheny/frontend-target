[TOC]

主要介绍的是机械硬盘

从以下内容进行讲解：
1. 硬件构造
2. 分区格式
3. 文件系统
4. 磁盘阵列

# 硬件构造
![硬盘结构图](http://c.biancheng.net/uploads/allimg/181012/2-1Q012154JE59.jpg)

机械硬盘由哪些硬件组成：
1. 串行接口：电源+数据传输
   1. 控制线
   2. 地址线
   3. 数据线
2. 空气过滤片：保证腔体无尘。这里我们可以思考一个问题，为什么需要空气过滤片？它是用于保证腔体内无尘的，如果我们想要腔体无尘，直接封闭腔体，不让空气进入不行吗？是什么理由要让空气进入腔体内呢？答案是散热，磁盘运转过程中会有电能消耗释放出热能，所以可以看到磁盘体外会有一个呼吸腔用于交换空气进行散热
3. 盘片-磁性物质，磁性物质的结构是影响磁盘容量的重要因素
4. 主轴-电能马达，驱动盘体旋转
5. 磁头-通过释放不同电流来改变磁性物质性质 
   1. 写：发出电流改变磁性物质性质
   2. 读：磁性物质可以让磁头产生感应电流，经过相关电路处理后会被还原成数据
6. 音圈马达：驱动磁头旋转
7. 永磁铁-断电时可以保证磁头停留在停泊区
8. 磁头停泊区-同样需要思考一个问题？为什么需要永磁铁和磁头停泊区，断电时，让磁头直接停留在盘片上，通电时继续旋转不行吗？答案是不行的，因为实际上读写数据时磁头和盘片并没有接触，如果断电时磁头直接停留在盘面上，一则通电时会阻碍磁盘旋转，二则两者的摩擦粘连会使得磁头和盘面受到损伤，因此磁盘不工作时，磁头需要被放置在磁头停泊区。其实除了这种方案之外，还有一种方案，在磁盘盘面中会设置一个内部环形区域，用于停泊磁头，但是同样的会有摩擦损伤，所以这种方案对磁头启停次数是有限制的。目前来说，永磁铁+磁头停泊区是较为通用的方案。

## 盘区分隔

![](https://pic1.zhimg.com/80/v2-dc762f4e4037b261d0134171213c94a0_720w.jpg)

从大到小分别是：
1. 盘片：磁盘由数个盘片构成，之前我在论坛有看过相关的拆解图片，希捷7200转的机械硬盘盘片厚度小于1分钱，和DVD厚度类似，一般来说4个盘片是比较常见的。
2. 盘面：盘片分为正反两面，从第一个盘片的正面开始记作0面、1面……磁头和盘面编号是对应的
3. 柱面
   1. 所有盘面的统一磁道构成一个圆柱，通常称作柱面
   2. 数据读写按柱面进行，即磁头读写时首先从当前柱面的0磁头开始操作，依次向下在不同磁头上进行操作，只有柱面磁头全部读写完成后才转移到下一柱面
   3. 磁头切换是电子切换，而柱面切换是机械切换，所以速度差距极大
4. 磁道
   1. 盘面有许多同心圆，这些同心圆轨迹叫做磁道；
   2. 磁道从外向内从0开始编号
   3. 磁道宽度取决于磁头大小，磁头越小，则盘面不变的情况下可容纳越多的磁道
5. 扇区：数据存储的最小单位，一般是512B，随着容量变大以及存取效率的考量，也出现了4K扇区，可以看作是磁道上的一小段圆弧

了解以上内容，我们知道硬盘读取速度由快到慢分别是： 
1. 同一柱面-磁头变换是电子切换
2. 同一磁道-机械轴不需要移动，速度相对较快
3. 不同磁道-目前来说最慢的部分，因为要移动机械轴，文件碎片读取速度慢就是因为散落在不同磁道上，因而在操作系统上通常都会提供碎片整合的功能，以优化读取效率

如果确实需要到不同的磁道中读取，那么磁盘内部也会控制读取数据，争取以最小的开销读取到所有磁道的数据，相应的调度算法有FCFS、SSTF、SCAN、C-SCAN、LOOK、C-LOOK等

# 磁盘分区
## MBR
第一个扇区是用于存放引导程序和分区表的，其余扇区用于实际分区。

### 引导程序
取值执行 + 跳转指定程序点

主要作用就是将操作系统程序装载到内存中。

### 分区
MBR最多可以支持4个主分区，或者将其中一个主分区换成扩展分区，扩展分区里可以自由的分割任意逻辑分区。

为什么MBR最多只支持4个主分区？

MBR格式下，第1个分区（0磁道0扇区）用于存放引导程序和分区表信息，引导程序占446字节，分区表信息占64个字节。

分区表信息可以记录四份分区表信息，1个分区表信息是16个字节，我们看一下这16个字节是怎么分配的：
1. 1Byte 存放引导标识，指名该分区是否是活动分区
2. 1Byte 起始磁头
3. 6bit 起始扇区
4. 10bit 起始柱面
5. 1Byte 分区类型描述，比如FAT16、FAT32、NTFS这些
6. 1Byte 结束磁头
7. 6bit 结束扇区
8. 10bit 结束柱面
9. 4Byte 本分区之前的扇区数，指从磁盘开始到此分区的偏移量
10. 4Byte 分区的总扇区数，指该分区所包含的扇区总数

影响容量最关键的部分就是最后两个信息，4字节限制最多容纳容量为：2^(4*8+9) = 2^41 = 2TB

## GPT
和MBR不一样，GBT使用LBA作为划分单位，MBR时期使用的扇区基本都是512B，但是时代发展之后，除了512B的扇区，现在还有4k的扇区，所以标准化现在使用LBA，LBA区块大小是512B，忽略物理扇区的不同。

使用了68个LBA记录引导程序及分区表：
1. LBA0：引导扇区446字节，外加1个标识符，标识是GPT分区格式
2. LBA1：管理LBA2-LBA33分区表的区块，记录对应的备份区块和校验码，如果校验码不匹配则使用备份区块对分区表进行恢复
3. LBA2-LBA33：分区表，每个LBA可以记录4组数据，1组数据可以使用128字节，并且起始和结束位置都分配了8字节，所以很富裕
4. LBA34-LBA67：备份

# 文件系统