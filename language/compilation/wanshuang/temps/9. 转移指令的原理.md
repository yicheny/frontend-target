[TOC]

# 什么是转移指令？
- 可以修改ip，或同时修改cs和ip的指令统称为转移指令
- 换一个角度，转移指令就是**可以控制CPU执行内存中某处代码的指令**

# 按修改范围分类
- 段间转移：修改cs和ip
- 段内转移：修改ip
    - 短转移：-128~127（2^8）
    - 近转移：-32768~32767（2^16）

# 按转移方式分类
- 无条件转移指令（如jmp）
- 条件转移指令（如jcxz）
- 循环指令（如loop）
- 过程
- 中断

# 操作符`offset`
用于获取标号的偏移地址

# `jmp`指令
可以修改`ip`，也可以同时修改`cs`和`ip`

执行`jmp`需要两种信息：
1. 目标地址
2. 转移范围【段间、段内短、段内近】

## 对标号的跳转
指令格式
- `jmp 标号`
- `jmp short 标号` 位移
- `jmp near ptr 标号` 位移
- `jmp far ptr 标号` 指定跳转

其他跳转
- `jmp 寄存器`
- `jmp 内存地址` 

## 转移细节【全书附注3】
1. 编译器有一个地址计数器（AC），AC在编译过程中，每读到一个字节AC+1。当遇到伪操作时，比如dw，db则AC会情况增加不同的值
2. **向前转移**时，
    1. 编译器读取标号定义区时记录下此时AC的值`aj`
    2. 读取到`jmp 标号`时，记录下此时AC的值`as`
    3. 通过`as-aj`算出位移值`disp`
    4. 根据`disp`值进行处理【下面有详细说明】
3. **向后转移**时
    1. 读取到`jmp 标号`时，由于没有读到标号定义区，所以不能确定`disp`的大小
    2. 将任意类型的`jmp`指令都当作`jmp short 标号`读取，记录下`jmp`此时对应的AC值`aj`
    3. 根据不同指令生成`EB`获得x个`nop`指令，`nop`用于预留1个字节的空间
        - `jmp short 标号` 预留1个
        - `jmp 标号`、`jmp near ptr 标号` 预留2个
        - `jmp far ptr 标号` 预留4个
    4. 继续工作，读取到对应标号定义区时，记录下AC值`as`
    5. 通过`as-aj`算出位移值`disp`
    6. 根据`disp`值进行处理【下面有详细说明】

### 向前转移
```
s:  ...
    ...
    ...
    jmp 标号【或者其他格式指令】
```

针对`disp`的值不同会做不同处理。

1. 如果`disp`属于`[-128,127]`
2. 不管原指令形式如何，都会将其转为`jmp short 标号`
3. `jmp short 标号`对应机器码为`EB disp`【占两个字节，比如`EB03`】

1. 如果`disp`属于`[-32768,32767]`
2. 原指令形式
    1. `jmp short 标号` 编译出错
    2. `jmp 标号`、`jmp near ptr 标号`将会将其转换为`jmp near ptr 标号`
    3. `jmp far ptr s`不变
3. 转换对应机器码
    1. `jmp near ptr 标号`对应`E9 disp`【占3个字节，比如`EB0201`】
    2. `jmp far ptr 标号`对应`EA 偏移地址:段地址`【占5个字节，比如`EA00101100`】


### 向后转移
```
s:  ...
    ...
    ...
    jmp 标号【或者其他格式指令】
```

1. 如果`disp`属于`[-128,127]`
2. 转换为`EB disp`【预留的nop空位可能用不上】

1. 如果`disp`属于`[-32768,32767]`
2. 转换为`EB disp`【如果只预留1个nop，则会编译报错】

## 内存地址跳转
1. `jmp word ptr 内存地址`（段内）
2. `jmp dword ptr 内存地址`（段间）

# `jcxz`指令
`jcxz 标号`【如果(cx)=0，则转移】

> 所有**有条件转移**都是**短转移**

# `loop`指令
`loop 标号`【如果(cx)!=0，则跳转】

> 循环是**短转移**

# 位移转移的意义
方便程序段在内存中的动态装配。

相关指令：
1. `jmp short 标号`
2. `jmp near ptr 标号`
3. `jcxz 标号`
4. `loop 标号`

# 超界
比如`jmp short`和`jmp near ptr`指令有限制范围，超过范围在编译时会报错！