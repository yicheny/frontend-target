[TOC]

# `int9`中断例程对键盘输入的处理
1. 键盘输入将引发9号中断，BIOS提供了9号中断例程
2. CPU在9号中断发生后，执行9号中断例程，
3. 例程从60h端口读取扫描码，并将其转换为相应的ASCII或状态信息，存储在内存的指定空间（键盘缓冲区或状态字节）中

> 键盘缓冲区实际是用环形队列进行管理的内存区，但这里我们数据结构上的讨论

示例：
1. 初始状态下，没有键盘输入，键盘缓冲区空，此时没有任何元素
2. 按下`A`键，引发9号中断
   1. CPU执行int9中断例程，从60h端口读出A键通码
   2. 然后检测状态字节，看是否有控制键或切换键按下，发现没有状态键按下
   3. 将A键的扫描码`1eh`和对应的ASCII码，即字母`a`的ASCII码`61h`写入键盘缓冲区
   4. 缓冲区的字单元中，高位字节存储扫描码，低位字节存储ASCII，所以会存储`1e61h`
3. 按下左`shift`键，引发9号中断
   1. CPU执行int9中断例程，从60h端口读出左`Shift`键通码
   2. 设置`0040:17`处的状态字节的第`1`位为1，表示左`shift`键按下
4. 按下`A`键，引发9号中断
   1. CPU执行int9中断例程，从60h端口读出`A`键通码
   2. 检测状态字节，发现左`Shift`键被按下
   3. 将`A`键的扫描码`1eh`和`Shift_A`对应的ASCII码，即字母`A`的ASCII码`41h`，写入键盘缓冲区
   4. 缓冲区的字单元中，高位字节存储扫描码，低位字节存储ASCII，所以会存储`1e41h`
5. 松开左`shift`键，引发9号中断
   1. CPU执行int9中断例程，从60h端口读出左`Shift`键通码
   2. 设置`0040:17`处的状态字节的第`1`位为0，表示左`shift`键松开
6. 按下`A`键，引发9号中断
   1. CPU执行int9中断例程，从60h端口读出A键通码
   2. 然后检测状态字节，看是否有控制键或切换键按下，发现没有状态键按下
   3. 将A键的扫描码`1eh`和对应的ASCII码，即字母`a`的ASCII码`61h`写入键盘缓冲区
   4. 缓冲区的字单元中，高位字节存储扫描码，低位字节存储ASCII，所以会存储`1e61h`

# 使用`in16h`中断读取键盘缓冲区
1. `BIOS`提供了`int 16h`中断例程供程序员调用
2. `int16h`中断例程的一个重要功能是：从键盘缓冲区中读取一个键盘输入，该功能的编号是0

`int16`的`0`号功能：
1. 检测键盘缓冲区中是否有数据
2. 没有则继续第1步
3. 读取缓冲区的第一个字单元的键盘输入
4. 将读取的扫描码送入ah，ASCII送入al
5. 将已读取的键盘输入从缓冲区删除


`int16h`和`int9h`是一对相互配合的程序，`int9`负责写入，`int16h`负责读取。两者读写时机不同
1. `int9`是在有**键按下**的时候像键盘缓冲区写入数据
2. `int16h`是在应用程序对其**进行调用**的时候，将数据从键盘缓冲区读出

# 字符串输入
用户通过键盘输入通常不是单个字符而是字符串。

最基本的字符串输入需要具备以下功能：
1. 在输入的同时需要显示这个字符串
2. 一般在输入回车符之后，字符串输入结束
3. 能够删除已经输入的字符

# 应用`int13h`中断例程对磁盘进行读写
以3.5英寸软盘为例进行说明

常用3.5寸软盘分为上下两面，每面80个磁道，每个磁盘分为18个扇区，每个扇区大小为512B

1. 磁盘的实际访问由磁盘控制器进行，我们可以通过控制磁盘控制器来访问磁盘
2. 只能以扇区为单位对磁盘进行读写
3. 读写扇区时，需要给出面号、磁道号、扇区号
4. 面号、磁道号从0开始，扇区号从1开始


1. 如果我们直接控制磁盘控制器访问磁盘，则需要涉及需要硬件细节；
2. 为此，BIOS提供了对扇区进行读写的中断例程
3. 这些中断例程完成了许多复杂的和硬件相关的工作
4. 我们一般通过调用BIOS中断例程来访问磁盘
5. BIOS提供访问磁盘的中断例程为`int 13h`

示例，读取0面0道1扇区内容到`0:200`
```
mov ax,0
mov es,ax
mov bx,200 ;es:bx指向从扇区读入数据的内存区

;入口参数
mov al,1 ;读取的扇区数量
mov ch,0 ;读取的磁道号
mov cl,1 ;读取的扇区号
mov dl,0 ;驱动器号 
mov dh,0 ;磁头号（对于软盘是面号，因为一个面用一个磁头读写）
mov ah,2 ;int13h的功能号，2号功能是读扇区，3号功能是写扇区
int 13h
```

关于驱动器号：
1. 软驱从0开始，0：软驱A，1：软驱B
2. 磁盘从80h开始，80h：硬盘C，81h：磁盘D

关于返回参数：
1. 操作成功：(ah)=0，(al)=读入的扇形数
2. 操作失败：(ah)=出错代码

# 逻辑扇区编号
1. 我们可以发现，使用面号、磁道号、扇区号来访问磁盘很不方便。
2. 为了方便对扇区的读取，我们将位于不同面、磁道的扇区进行统一编号。
3. 编号从0开始，我们成这个编号为逻辑扇区编号

编号示例：
```
物理扇区号        逻辑扇区号
0面0道1扇区       0
0面0道2扇区       1
0面0道3扇区       2
.
.
0面79道18扇区     1439
1面0道1扇区       1440
1面0道2扇区       1441
1面0道3扇区       1442
```

逻辑扇区号和物理扇区号关系：逻辑扇区号 = (面号\*80+磁道号)\*18+扇区号-1

根据逻辑扇区号算出物理编号：
> int() 描述性运算符，取商；rem() 描述性运算符，取余
1. 面号=int(逻辑扇区号/1440)
2. 磁道号=int(rem(逻辑扇区号/1440)/18)
3. 扇区号=rem(rem(逻辑扇区号/1440)/18)+1

# PC开机过程
1. 开机后，CPU自动进入到`0ffff:0`单元处执行，此处有一条跳转指令。
2. CPU执行该指令，转去执行BIOS硬件系统检测和初始化程序
3. 初始化程序将建立BIOS所支持的中断向量，即将BIOS提供中断例程的入口地址登记在中断向量表中
4. 硬件系统检测和初始化完成后，调用`int19h`进行操作系统的引导
5. 如果设为从软盘启动操作系统，则`int19h`将主要完成以下工作：
   1. 控制0号软驱，读取软盘0道0面1扇区的内容到`0:7c00`
   2. 将cs:ip指向`0:7c00`
   3. 软盘的0道0面1扇区中装有操作系统引导程序，`int19h`将其装到`0:7c00`处后，设置CPU从`0:7c00`开始执行此处的引导程序，操作系统被激活，控制计算机
7. 如果0号软驱中没有软盘，或发生软盘I/O错误，则`int19h`将主要完成以下工作：
   1. 读取硬盘C的0道0面1扇区的内容到0:7c00
   2. 将CS:IP指向`0:7c00`