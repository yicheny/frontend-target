[TOC]

# 什么是数据库？
简单的说就是数据集合，这些数据会**持久**保存。

## 发展
1. 最早的商用数据库出现在20世纪60年代，是从文件系统演变而来，对于现代数据库应当满足的5大特性，只满足一条，就是可以持久保存数据。以我们现在的眼光看来，它缺乏许多数据库重要的特性，比如说高效的查询速度，没有可以简单操作的语言，对同时修改没有保障等等
2. 20世纪70年代，弗兰克-埃德加-科德发布了自己的论文，这个关系型数据库的开山祖师首次提出关系性数据库的概念，认为用户不需要关注数据的存储结构，数据库应当提供简单易懂的操作方式，这对数据库领域产生了革命性的变化
3. 变化
   1. 越变越小：指软件本身，一开始只能在大型计算机上使用，现在个人计算机也能使用了
   2. 越变越大：指存储的数据，从普通的文本，到图片、电影、网络数据流等等
   3. 信息集成：指现在数据可能分布在同个公司的不同服务器上，需要集成数据

# 数据库系统概述   
来源：
1. 普通用户和应用程序：查询和修改数据
2. DBA（数据库管理员）：创建数据库模式和结构的一个或一组人

执行流程见：

![数据库管理系统成分](https://pic.imgdb.cn/item/62c3ad2a5be16ec74a380435.jpg)

## DDL
1. 模式的创建修改都是由定义的DDL命令处理的
2. DBA需要特殊权限才能执行模式修改
   1. 进行模式修改，会编写对应的DDL命令，然后交给DDL程序处理
   2. DDL程序处理之后传给执行引擎
   3. 执行引擎经过 索引/文件/记录管理器 去改变元数据【数据库的模式信息】

## DML
DML用于
1. 修改数据库数据【如果是修改命令】
2. 提取数据库数据【如果是查询命令】

## 查询响应
1. **查询编译器**对查询进行分析和优化
2. 优化后的查询命令被传给**执行引擎**
3. 执行引擎向**资源管理器**发出一系列对小的数据单元（通常是`tuple`）的请求
   - 资源管理器有着数据文件、记录文件数据格式和大小的文件、支持快速查找的索引文件
4. 查找数据的请求被传送给**缓冲区管理器**，它负责将磁盘中的一些数据取到主存的缓冲区中，传输单位通常是页
5. 缓冲区管理器和**存储管理器**进行通信，以从磁盘获取数据。存储管理器可能使用操作系统命令，但通常情况下，DBMS直接发送命令给**磁盘控制器**

## 存储控制器
数据库数据通常保存在辅助存储器中，数据必须在主存中，才能进行处理，存储管理器的作用就是控制数据在磁盘和主存之间的移动。

简单的数据库系统里，存储管理器和一般文件系统区别不大。不过更多情况下，为了提高效率，存储管理器会做很多处理，比如说追踪文件在磁盘上的位置，加速获取缓冲区管理器所需要的文件的磁盘号。

缓冲区管理器负责将分配的内存空间分割成缓冲区，然后将磁盘数据放到缓冲区中，所有需要从磁盘中换取的信息都要经过缓冲区，要么直接与缓冲区交互，要么通过执行引擎与缓冲区交互。

交互的数据类型包括：
1. 数据：数据库自身内容
2. 元数据：描述数据库的结构及约束的数据库模式
3. 日志记录：记录命令，以支持数据库持久性
4. 统计信息：数据库的关系及大小、取值等
5. 索引：支持对数据进行高效存储的数据结构

## 事务处理
事务就是组成一组的查询或修改命令。

ACID：
- A 原子性
- C 统一性
- I 孤立性
- D 持久性

事务处理器分成以下两部分：
1. **并发控制管理器**，负责A、I
2. **日志和恢复管理器**，负责D

事务处理器执行以下任务：
1. 日志记录
2. 并发控制：通过各类锁
3. 死锁解决：通过中止或回滚

## 查询处理器
对用户来说数据库执行影响最大的部分。

组成：
1. **查询编译器**：将接收到的查询指令编译优化为内部形式，叫做**查询计划**
   1. **查询分析器** 将文本形式的查询 转换为 树结构
   2. **查询预处理器** 进行语义检查，将分析树转换为  表示最初查询计划的 代数操作树
   3. **查询优化器** 将最初的查询计划 优化成 最有效的操作序列
2. **执行引擎**：负责与DBMS中的大多数成分都有交互，或是直接交互，或是通过缓冲区。
   1. 为了对数据进行操作，它必须将数据库的数据提取到缓冲区中
   2. 需要和调度器交互，以避免访问被加了锁的数据
   3. 需要和日志管理器进行交互，以确保对于数据的所有修改都记录到日志中

> 查询编译器通常通过元数据和数据的统计数据来评估哪个操作序列可能是最快的，一个简单的例子：通过索引的查询比不通过索引的查询要快的多

# 本书概述
第一部分：数据库系统实现
1. **存储管理**
   1. 如何基于磁盘存储来组织数据以实现高效访问
   2. B-树结构
2. **查询处理**
   1. **查询执行** 查询的算法
   2. **查询编译** 如何从一个给定查询的所有可能执行方法中选择一个高效的查询计划
3. **事务处理**
   1. 日志
   2. 调度
   3. 死锁
   4. 分布式

第二部分：现代数据库系统专题
1. 搜索引擎如何工作
2. 信息集成和数据库共享数据
3. 数据挖掘，研究以复杂方式处理大量数据和许多有趣重要的算法
4. 数据流系统：处理连续到达系统的数据，他们的查询能被及时而连续的响应

# 数据库模型和语言回顾
## 基本名词
1. 列是**属性**
2. 行是**元组**（值的集合）
3. 表是为**关系**（元组的集合）
4. 关系名、属性名及属性类型 称作**关系模式**
5. 关系模式的集合是**数据库模式**

## SQL
SQL具有多种能力，包括查询和修改：
- 查询：`SELECT`
- 修改：
  - 插入 `INSERT`
  - 删除 `DELETE`
  - 更新 `UPDATE`

关于查询，查询通常通过`select-from-where`语句，一般形式如下（只有前两行是必须的）：
```sql
SELECT      <属性表>
FROM        <关系表>
WHERE       <条件>
GROUP BY    <属性表>
HAVING      <条件>
ORDER BY    <属性表>
```
查询的结果可以计算如下（还有其他更好的计算方式）：
1. 从`FROM`子句中列出各个关系的元组的所有可能组合
2. 将不符合`WHERE`子句中给出的条件的元组去掉
3. 如果有`GROUP BY`子句，则剩下的元组按`GROUP BY`子句中给出的数值的值分组
4. 如果有`HAVING`子句，则按`HAVING`子句中给出的条件检查每个组，去掉不符合条件的组
5. 按照`SELECT`子句的说明，对于指定的属性和属性上的聚集（例如一组中的和）计算出结果元组
6. 按照`ORDER BY`子句中的属性列的值对结果元组进行排序

### 一般查询
范例1：找出`Paramount`电影明星及电影名
```sql
SELECT StarName, Movie.title
FROM Movie, StarsIn
WHERE Movie.title = StartsIn.title AND
      Movie.year = Starts.year AND
      StudioName = 'Paramount'
```

范例2：找出至少在3部影片中出现的明星的最早出现年份
```sql
SELECT StarName, MIN(year) AS minYear
FROM StartsIn
GROUP BY starName
HAVING COUNT(*) >= 3
ORDER BY minYear
```

### 子查询
SQL所提供的强力特性之一是在`WHERE`、`FROM`、`HAVING`子句中使用子查询的能力。子查询是一个完整的`select-from-where`语句，在上述的`WHERE`、`FROM`或`HAVING`子句中会检查子查询的值。

范例3-子查询：找出不在`Hollywood`生产的影片的名字和年代
```sql
SELECT name
FROM Studio
WHERE address NOT LIKE '%Hollywood%'
```
这个子查询的查询结果会被用到外层查询的`WHERE`子句中，去找出现在这一制片厂名字集合中的影片

范例4：例3的完整查询
```sql
SELECT title,year
FROM Movie
WHERE studioName IN (
   SELECT name
   FROM Studio
   WHERE address NOT LIKE '%Hollywood%'
);
```


### 视图
SQL的另一个重要negligence是视图的定义，这是对于 不实际存储 但在需要时 从实际存储关系 构造出来的关系的描述。

范例5：创建视图
```sql
CREATE VIEW ParamountMovie AS
   SELECT title,year
   FROM Movie
   WHERE studioName = 'Paramount'
```

# 名词
- `DBA`：`database administrator` 数据库管理员
- `DDL`：数据定义语言
- `DML`：数据操作语言