
局域网路由器将网络包通过网关发送后并没有直接进入互联网，而是先发送到接入网，然后经接入网进入互联网。

这里我们得说一下互联网和局域网得不同。

从抽象的角度考虑，互联网的原理和局域网是相同，同样是通过路由器和ip进行转发。

不过也有一些不同，其一是距离，局域网距离很近，所以传输线很短就可以满足需要，但是互联网不行，互联网距离相差很远，比如说我可能需要将数据从中国传到美国，那么局域网短短几十米的传输线根本就满足不了需要。

其二是路由器数量，局域网内路由器数量相对可控，而互联网中存在数十万台路由器，而且随着时间日益增长中，所以互联网中的路由表维护策略和局域网策略是不同的，至少它不能手动维护是不是？另外虽然局域网也有自动维护路由表的策略，不过互联网的维护策略和局域网策略是不同的。【为什么？】

现在回到接入网，接入网有很多类型，比如电话线、ADSL、FTTH这些，有些公司可能会使用专线，这里我介绍两种典型接入网：ADSL、FTTH

# ADSL
ADSL，即不对称数字用户线，是一种用架设在电线杆上的金属线进行高速通信的技术，因为它的上行速度（用户到互联网）和下行速度（互联网到用户）的速度不一致，故此得名。

通路过程：

局域网路由器
- MAC、IP
- 转换电信号发送

ADSL路由器
- 接收包
- MAC、POPoE、PPP

ADSL Modem
- 接收包
- 转换为ATM信元发送
- 转换为电信号并发送

调制技术就是将使用圆滑波形【弦形波】表示数字的技术，主要有振幅调制和相位调制两种

同时，调制解决了方形信号容易失真受损的问题

而且，调制会使用多个频段进行信号传输，在不容易产生噪音的低频会多传信息，在容易产生噪音的高频会少传信息。

分离器
- 接收信号
- 分离电话信号和ATM信元发送

从分离器出来之后就是电话的接口，信号经过室内电话线，然后会到达大楼的IDF【中间配线盘】和MDF【主配线盘】，配线盘之后是保安器，在之后就是电线杆上架构的电缆。

然后说一下电缆，电缆 -> 单元 -> 子单元 -> 四芯电话线，四芯电话线中相对的两个线组成一条线路。

电缆传输时通常假设在电线杆上，在住宅区附近时可以的，然而电话局是汇总点，如果架设电话杆那么会密密麻麻的都堆在一起，很占据空间，而且会引发防灾方面的隐患，所以实际电缆在电话局汇总时并不是通过电线杆，而是埋在地下进行传输的，很多电缆放在一起就形成了电缆隧道，电缆隧道就是用于拜访电缆的通道。

DSLAM
- 接收电信号
- 将电信号转换为信元发送

BAS
- 接收信元
- 将信元转换为网络包
- 取出PPP包
- 添加隧道头部
- 发送

隧道路由器
- 接收隧道包
- 取出ip包
- 发送给互联网内部

## 流程概览
1. 内网路由器
   1. 添加IP头部
   2. 添加MAC头部并发送
2. 接入网路由器
   1. 接受包
   2. 取出IP包
   3. 添加MAC、PPPoE、PPP头部
3. ADSL Modem
   1. 接收包
   2. 拆分为ATM信元
   3. 转换为电信号并发送 
4. DSLAM
   1. 接收电信号
   2. 转换为ATM信元并发送
5. BAS
   1. 接收ATM信元
   2. 还原为网络包
   3. 取出PPP包
   4. 添加隧道头部并发送（如L2TP隧道）
6. 路由器（隧道专用）
   1. 接收隧道包
   2. 取出IP包
   3. 发送到互联网内部

# FTTH
## 什么是光纤？

双层结构的纤维状透明材质构成【玻璃和塑料】，通过里面的纤芯传导光信号来传输信息，通过明暗表示0、1

## 通信原理

数字信号转电信号，0转为低电压、1转为高电压，然后接入LED、激光二极管这一类光源，则低电压发光暗，高电压发光亮，然后随着光纤到达接收端，接收端是光敏材料，亮光则产生高电压，暗光则产生低电压，然后将电信号转换为数字信号

## 单模和多模
光的传导收折射率和透光率影响，简单的说就是发射角度越小，越容易进行折射，相反，发射角度越大，越容易投射出去。

然后是相位，和水波类似，相反的相位光波会相互抵消，所以光传导要求相位必须相同。

光的传导受很多方面影响，比如说材质不同，透光率、折射率有很大差别；其中材质不变的情况下，纤芯直径影响最大。

原因就在于光纤越粗，就可以接收发射角度更大的光，如此一来可以发射更多的光，相反的，越细的纤芯对发射角度越严格，可以发射的光越少。

所谓单模和多模，就是指可以一次发射单个光源还是多个光源。

多模因为角度不同，到达时间会所有差异，同时，光波宽度也会因角度而产生差异，所以多模并不适合超长距离传输，FTTH使用的是单模光纤。

## 直连和分路
FTTP有两种方式，第一种是直连，就是用户和电话局通过一根光纤直接连接，发送方这边会有一个光纤收发器将以太网电信号转化为光信号，电话局则是有一个多路光纤收发器，将多个用户的光信号接收并转换为电信号传输给互联网。

传输时一根光纤会同时接发信号，这里上行和下行会使用不同波长的光，所以无需担心光混合的问题，这里会使用滤波器将其分离【棱镜原理】，这里在一个光纤中使用不同波长的光波传输多种信号的方式叫做**波分复用**

另一种是分路，就是用户信息会发送到分光器，分光器将信号传输到ONU由其统一处理为光信号发送给电话局，电话局这边使用OLT将其转换为电信号传给互联网。

本质上ONU、OLT和光纤收发器做的事是相同的，只是ONU、OLT需要处理信号碰撞的问题，因为这里同时收发多个用户的信息，所以可能会发生信息碰撞。

## 流程概览
1. 内网路由器
   1. 添加IP头部
   2. 添加MAC头部并发送
2. 接入网路由器
   1. 接受包
   2. 取出IP包
   3. 添加MAC、PPPoE、PPP头部
3. 光纤收发器/ONU
   1. 接收包
   3. 转换为光信号并发送
4. 多路光纤收发器/OLT
   1. 接收光信号
   2. 转换为电信号并发送
5. BAS
   1. 接收包
   2. 取出PPP包
   3. 添加隧道头部并发送（如L2TP隧道）
6. 路由器（隧道专用）
   1. 接收隧道包
   2. 取出IP包
   3. 发送到互联网内部

# BAS
如果想要进入互联网进行访问，首先需要获取公网ip这些信息，这些信息并不是绑定在网卡上的，我们要怎么获取和配置这些信息呢？

BAS就是用于分配公网IP、DNS服务器、默认网关IP的高阶路由器。

接入网路由器首先配置好运行商分配的账号密码，然后将其封装到PPP协议中，PPP协议并不是用于物理层传输的协议，所以需要放到容器中进行传输。

在电话拨号时代，是通过HDLC协议进行传输的，而在目前的互联网中，则主要使用PPPoE协议进行传输，这个E就是指以太网协议，简单来说就是将PPP包放到以太网中然后通过以太网协议进行传输。

传输分为加密和不加密两种情况，加密会使用CHAP协议，不加密则使用PAP协议。

PPPoE信息传输到BAS服务器之后，BAS会取出PPP包部分，然后通过RADIUS协议发送给RAS进行验证后，验证通过将相关的公网ip、默认网关、dns服务器这些信息发送给接入网路由器，然后接入网路由器按这些进行配置后，就可以对互联网进行访问了。

之后发送请求，接入网路由就可以按照一般流程进行访问了。【除了第一次配置，之后不需要每一次进行验证】

然后数据来到BAS，BAS会通过隧道【TCP/封装】将数据传递给互联网。

除了PPPoE协议之外，有时也会使用PPPoA协议，A即ATM，这种方式的缺陷在于现代计算机中并没有ADSL modem存在，所以无法直接通过计算机接收和处理ATM信息。

为此，有两种方案，其1是将ADSL modem通过ubs和计算机连接以支持调制，不过这种方案不没有得到普及。

其2是将ADSL model内置到路由器，只要连接就可以通过路由器就行解析。这种方案的缺陷在于之后计算机访问互联网必须经过路由器，另一个问题是难以处理地址转换的问题。

使用PPPoA的优势在于传输的信息量会更少，因为PPPoE协议需要添加额外的以太网报头，而PPPoA不需要。

总的来说，PPPoE、PPPoA都有着一些缺陷，现在还有一种流行方案是通过DHCP协议配置，简单来说就是直接请求DHCP服务器获取配置，DHCP返回给接入网路由器响应配置，然后直接就可以访问互联网了。

## POP、NOC
通过接入网接入POP，就真正进入了互联网内部。

接入网连接POP有以下几种方式：
1. 专线
2. 电话线/ISDN
3. PPPoE
4. PPPoA

POP和其他POP、NOC连接，如果距离比较近，比如说在一栋楼里面，那么直接连接就行【通常是多模光纤、双绞线】。

如果是长距离，则需要使用单模光纤进行连接，但是这个成本是极高的，有两种方案，第一种，大运营商会部署相关光纤线路，而一般的中小型运营商没有这个资本和实例部署这个量级的光纤，对此他们使用第二种方案，租借大运营商的光纤服务，注意，不是光纤，而是光纤本身，因为一根光纤不止能传一种信号，租借光纤服务对于大运营商来说，就是我不光传输自己的信号，同时还可以传输其他其他运营商的信号。

## IX
运营商如何获取其他运行商的网络呢？

两个方案：
> 交换的信息是指路由表信息

第一种，运营商通过接入路由器和其他运营商交换信息，这种机制叫做BGP，BGP交换分为两种：
1. 交换全部网络信息，比如说将运营商B的信息交还给运营商A，运营商B路由器里有其他运营商的信息，可以将这部分信息一起交换出去，这样运营商A可以越过B直接访问其他运营商，这种方式叫做**转接**
2. 运营商A、B只交换各自网络的信息，这种叫做**非转接**、**对等**

这里需要说明下的是，公司内网中转发是以最短路径做转发的，但是在运营商里却不是这么做的，因为运营商的线路是自己部署的，假设运营商从中国到美国有一条最短线路，这条线路不会给所有运营商都用，那么谁可以用？交服务费的可以用。

因为运营商需要靠这个赚钱，所以不仅只是区分收费不收费，还可以根据收费级别提供不同的线路，运营商路由器是可以调整线路级别的，这是和公司路由器的一个区别。

另外，如果运营商没收到另一个运营商的钱，它完全可以不和另一个运营商进行数据交换。当然这个时候可能会有人问：如果禁止交换，那么这个请求不是达到不了目标地址了吗？其实并不会，这个运营商不给走，换一个就行，一个运营商通常和多个运营商之间有联系，这个走不了换一个就行，总之绝对会保证可以连接到互联网中的任何一个点，如果做不到，这个运营商就该倒闭了。

第二种，通过IX进行集中式数据交换

相比双边交换模式，可以感受到IX方案的优越性：
1. 单运行商存储的信息减少
2. 方便集中控制
3. 方便交换信息【双边是所有的都需要交换，而IX可以只放到中心，复杂度是n^2和n的区别】

IX在互联网中非常重要，IX的部署场所需要有自主发电设备，以及地震、台风、火灾等对做防灾处理，所以一般会有专门的设施进行放置，这里说一下IX和NOC的连接方式，如果距离近，则通过网线直接连接，如果距离远，则使用路由器和网线进行连接。

# 名词
- **DSLAM**：DSL Access Multiplexer，数字用户线接入复用设备。它是一种电 话局用的多路 ADSL Modem，可以理解为将多个 ADSL Modem 整合在一个外壳里的设备。
- **ADSL**：Asymmetric Digital Subscriber Line，不对称数字用户线。它是一种
利用架设在电线杆上的金属电话线来进行高速通信的技术，它的上行方向
（用户到互联网）和下行方向（互联网到用户）的通信速率是不对称的。
- **FTTH**：Fiber To The Home，光纤到户。指的是将光纤接入家庭的意思、
- **ATM**：Asynchronous Transfer Mode，异步传输。它是在以电话线为载体的 传统电话技术基础上扩展出来的一种通信方式。它的数据传输是以“信元”为单位来进行的，这和以包为单位传输数据的 TCP/IP 很像，但这种方式并不适用于计算机通信。
- **PPP**：Point-to-Point Protocol，点到点协议。它是电话线、ISDN 等通信线路所
  使用的一种协议，集成了用户认证、配置下发、数据压缩、加密等各种功能。
- **BGP**：Border Gateway Protocol，边界网关协议。
- **HDLC**：High-level Data Link Control，高级数据联接控制。
- **CHAP**：Challenge Handshake Authentication Protocol，挑战握手认证协议。
- **PAP**：Password Authentication Protocol，密码验证协议。
- **RADIUS**：Remote Authentication Dial-in User Service，远程认证拨号用户服务。