
局域网路由器将网络包通过网关发送后并没有直接进入互联网，而是先发送到接入网，然后经接入网进入互联网。

这里我们得说一下互联网和局域网得不同。

从抽象的角度考虑，互联网的原理和局域网是相同，同样是通过路由器和ip进行转发。

不过也有一些不同，其一是距离，局域网距离很近，所以传输线很短就可以满足需要，但是互联网不行，互联网距离相差很远，比如说我可能需要将数据从中国传到美国，那么局域网短短几十米的传输线根本就满足不了需要。

其二是路由器数量，局域网内路由器数量相对可控，而互联网中存在数十万台路由器，而且随着时间日益增长中，所以互联网中的路由表维护策略和局域网策略是不同的，至少它不能手动维护是不是？另外虽然局域网也有自动维护路由表的策略，不过互联网的维护策略和局域网策略是不同的。【为什么？】

现在回到接入网，接入网有很多类型，比如电话线、ADSL、FTTH这些，有些公司可能会使用专线，这里我介绍两种典型接入网：ADSL、FTTH

# ADSL
ADSL，即不对称数字用户线，是一种用架设在电线杆上的金属线进行高速通信的技术，因为它的上行速度（用户到互联网）和下行速度（互联网到用户）的速度不一致，故此得名。

通路过程：

局域网路由器
- MAC、IP
- 转换电信号发送

ADSL路由器
- 接收包
- MAC、POPoE、PPP

ADSL Modem
- 接收包
- 转换为ATM信元发送
- 转换为电信号并发送

调制技术就是将使用圆滑波形【弦形波】表示数字的技术，主要有振幅调制和相位调制两种

同时，调制解决了方形信号容易失真受损的问题

而且，调制会使用多个频段进行信号传输，在不容易产生噪音的低频会多传信息，在容易产生噪音的高频会少传信息。

分离器
- 接收信号
- 分离电话信号和ATM信元发送

从分离器出来之后就是电话的接口，信号经过室内电话线，然后会到达大楼的IDF【中间配线盘】和MDF【主配线盘】，配线盘之后是保安器，在之后就是电线杆上架构的电缆。

然后说一下电缆，电缆 -> 单元 -> 子单元 -> 四芯电话线，四芯电话线中相对的两个线组成一条线路。

电缆传输时通常假设在电线杆上，在住宅区附近时可以的，然而电话局是汇总点，如果架设电话杆那么会密密麻麻的都堆在一起，很占据空间，而且会引发防灾方面的隐患，所以实际电缆在电话局汇总时并不是通过电线杆，而是埋在地下进行传输的，很多电缆放在一起就形成了电缆隧道，电缆隧道就是用于拜访电缆的通道。

DSLAM
- 接收电信号
- 将电信号转换为信元发送

BAS
- 接收信元
- 将信元转换为网络包
- 取出PPP包
- 添加隧道头部
- 发送

隧道路由器
- 接收隧道包
- 取出ip包
- 发送给互联网内部

## 流程概览
1. 内网路由器
   1. 添加IP头部
   2. 添加MAC头部并发送
2. 接入网路由器
   1. 接受包
   2. 取出IP包
   3. 添加MAC、PPPoE、PPP头部
3. ADSL Modem
   1. 接收包
   2. 拆分为ATM信元
   3. 转换为电信号并发送 
4. DSLAM
   1. 接收电信号
   2. 转换为ATM信元并发送
5. BAS
   1. 接收ATM信元
   2. 还原为网络包
   3. 取出PPP包
   4. 添加隧道头部并发送（如L2TP隧道）
6. 路由器（隧道专用）
   1. 接收隧道包
   2. 取出IP包
   3. 发送到互联网内部

# FTTH
## 什么是光纤？

双层结构的纤维状透明材质构成【玻璃和塑料】，通过里面的纤芯传导光信号来传输信息，通过明暗表示0、1

## 通信原理

数字信号转电信号，0转为低电压、1转为高电压，然后接入LED、激光二极管这一类光源，则低电压发光暗，高电压发光亮，然后随着光纤到达接收端，接收端是光敏材料，亮光则产生高电压，暗光则产生低电压，然后将电信号转换为数字信号

## 单模和多模
光的传导收折射率和透光率影响，简单的说就是发射角度越小，越容易进行折射，相反，发射角度越大，越容易投射出去。

然后是相位，和水波类似，相反的相位光波会相互抵消，所以光传导要求相位必须相同。

光的传导受很多方面影响，比如说材质不同，透光率、折射率有很大差别；其中材质不变的情况下，纤芯直径影响最大。

原因就在于光纤越粗，就可以接收发射角度更大的光，如此一来可以发射更多的光，相反的，越细的纤芯对发射角度越严格，可以发射的光越少。

所谓单模和多模，就是指可以一次发射单个光源还是多个光源。

多模因为角度不同，到达时间会所有差异，同时，光波宽度也会因角度而产生差异，所以多模并不适合超长距离传输，FTTH使用的是单模光纤。

## 直连和分路
FTTP有两种方式，第一种是直连，就是用户和电话局通过一根光纤直接连接，发送方这边会有一个光纤收发器将以太网电信号转化为光信号，电话局则是有一个多路光纤收发器，将多个用户的光信号接收并转换为电信号传输给互联网。

传输时一根光纤会同时接发信号，这里上行和下行会使用不同波长的光，所以无需担心光混合的问题，这里会使用滤波器将其分离【棱镜原理】，这里在一个光纤中使用不同波长的光波传输多种信号的方式叫做**波分复用**

另一种是分路，就是用户信息会发送到分光器，分光器将信号传输到ONU由其统一处理为光信号发送给电话局，电话局这边使用OLT将其转换为电信号传给互联网。

本质上ONU、OLT和光纤收发器做的事是相同的，只是ONU、OLT需要处理信号碰撞的问题，因为这里同时收发多个用户的信息，所以可能会发生信息碰撞。

## 流程概览
1. 内网路由器
   1. 添加IP头部
   2. 添加MAC头部并发送
2. 接入网路由器
   1. 接受包
   2. 取出IP包
   3. 添加MAC、PPPoE、PPP头部
3. 光纤收发器/ONU
   1. 接收包
   3. 转换为光信号并发送
4. 多路光纤收发器/OLT
   1. 接收光信号
   2. 转换为电信号并发送
5. BAS
   1. 接收包
   2. 取出PPP包
   3. 添加隧道头部并发送（如L2TP隧道）
6. 路由器（隧道专用）
   1. 接收隧道包
   2. 取出IP包
   3. 发送到互联网内部

# BAS
BAS是什么？从刚刚的流程里我说了它负责接收包，取出PPP包，然后在IP包加上隧道头部发给隧道路由器

然而实际上它还肩负着另一个重要责任，对PPP包的处理就是它负责的，BAS是具有更强大功能的高阶路由器。

首先说一下PPP，PPP集成了用户认证、配置下发、数据压缩、加密等功能，主要是用户认证，PPP里面含有用户信息和密码，BAS负责将PPP信息传给认证服务器，通过验证后，认证服务器将对应的ip地址等配置传给用户，用户需要使用这些配置完成配置，拥有了公网ip之后才能在互联网中传输数据。

通过这种方式配置公网ip是灵活的，首先我们知道必须有公网ip才能在互联网中进行传输，所以需要配置公网ip，我们知道计算机本身没有ip地址，通过账户和密码的方式分配ip可以方便的切换ip。

实际上无论ADSL、FTTH协议，都是通过电缆或光纤进行连接的，所以即使不登陆，一样是可以确定用户的，但是ADSL、FTTH协议还是使用了PPP协议，原因是这样可以很方便的切换ip。

ppp信息不能直接被发送，需要放到容器里发送，在电话拨号上网时，使用的是HDLP协议，但是在ADSL和FTTH中不能使用HDLP，因为不兼容。

FTTH、ADSL使用PPPoE协议，翻译过来就是以太网点对点协议，在传输时会将PPP放在PPPoE包中传输，简单来说就是将数据放到以太网包中。

另外说一下BAS传输信息时，信息是需要保密的，因此需要用到CHAP协议或PAP协议。

BAS隧道实现有多种方案，举例两种TCP隧道、封装隧道是常用方案，但是只要可以保证输出的数据和输入的数据相同，就可以认为满足隧道要求。

除了PPPoE方案，还有PPPoA方案，这种方案的优势在于不用封装PPPoE信息，直接将PPP包拆分成信元传输，所以数据量相对更少，或者说MTU更大。

然后这种方案要求传输双方必须使用ATM格式进行传输，所以需要用到ADSL DSLAM，为此有两种方案。

第一种就是将ADSL DSLAM通过USB接口直接和计算机连接，不过这种方案没有被普及

第二种是将ADSL DSLAM集成到路由器里面。

说一下PPPoA方案的一些缺陷，因为路由器会对内网地址做地址转换，对浏览器、邮件这些应用程序没有影响，但是对于某些应用程序可能造成影响，所以如果地址转换出现问题，可以直接将PPPoE的信息传给计算机使用，这样计算机可以直接使用公网进入互联网，可以解决地址转换导致的问题。

不过需要注意的是，如此一来计算机就失去了路由器的防护，需要安装防火墙等程序保证网络安全。

回到PPPoA，使用PPPoA方案就不能解决地址转换导致的问题了。

接下来介绍第三种方案，即DHCP协议，这个协议很简单，用户请求配置，运营商动态分配配置，用户不需要登录账号密码，所以很简单，而且省却了PPP信息，所以数据量更少、MTU更大

## POP、NOC
通过接入网接入POP，就真正进入了互联网内部。

接入网连接POP有以下几种方式：
1. 专线
2. 电话线/ISDN
3. PPPoE
4. PPPoA

POP和其他POP、NOC连接，如果距离比较近，比如说在一栋楼里面，那么直接连接就行【通常是多模光纤、双绞线】。

如果是长距离，则需要使用单模光纤进行连接，但是这个成本是极高的，有两种方案，第一种，大运营商会部署相关光纤线路，而一般的中小型运营商没有这个资本和实例部署这个量级的光纤，对此他们使用第二种方案，租借大运营商的光纤服务，注意，不是光纤，而是光纤本身，因为一根光纤不止能传一种信号，租借光纤服务对于大运营商来说，就是我不光传输自己的信号，同时还可以传输其他其他运营商的信号。

## IX
运营商如何获取其他运行商的网络呢？

两个方案：
> 交换的信息是指路由表信息

第一种，运营商通过接入路由器和其他运营商交换信息，这种机制叫做BGP，BGP交换分为两种：
1. 交换全部网络信息，比如说将运营商B的信息交还给运营商A，运营商B路由器里有其他运营商的信息，可以将这部分信息一起交换出去，这样运营商A可以越过B直接访问其他运营商，这种方式叫做**转接**
2. 运营商A、B只交换各自网络的信息，这种叫做**非转接**、**对等**

这里需要说明下的是，公司内网中转发是以最短路径做转发的，但是在运营商里却不是这么做的，因为运营商的线路是自己部署的，假设运营商从中国到美国有一条最短线路，这条线路不会给所有运营商都用，那么谁可以用？交服务费的可以用。

因为运营商需要靠这个赚钱，所以不仅只是区分收费不收费，还可以根据收费级别提供不同的线路，运营商路由器是可以调整线路级别的，这是和公司路由器的一个区别。

另外，如果运营商没收到另一个运营商的钱，它完全可以不和另一个运营商进行数据交换。当然这个时候可能会有人问：如果禁止交换，那么这个请求不是达到不了目标地址了吗？其实并不会，这个运营商不给走，换一个就行，一个运营商通常和多个运营商之间有联系，这个走不了换一个就行，总之绝对会保证可以连接到互联网中的任何一个点，如果做不到，这个运营商就该倒闭了。

第二种，通过IX进行集中式数据交换

相比双边交换模式，可以感受到IX方案的优越性：
1. 单运行商存储的信息减少
2. 方便集中控制
3. 方便交换信息【双边是所有的都需要交换，而IX可以只放到中心，复杂度是n^2和n的区别】

IX在互联网中非常重要，IX的部署场所需要有自主发电设备，以及地震、台风、火灾等对做防灾处理，所以一般会有专门的设施进行放置，这里说一下IX和NOC的连接方式，如果距离近，则通过网线直接连接，如果距离远，则使用路由器和网线进行连接。

# 名词
- **DSLAM**：DSL Access Multiplexer，数字用户线接入复用设备。它是一种电 话局用的多路 ADSL Modem，可以理解为将多个 ADSL Modem 整合在一个外壳里的设备。
- **ADSL**：Asymmetric Digital Subscriber Line，不对称数字用户线。它是一种
利用架设在电线杆上的金属电话线来进行高速通信的技术，它的上行方向
（用户到互联网）和下行方向（互联网到用户）的通信速率是不对称的。
- **FTTH**：Fiber To The Home，光纤到户。指的是将光纤接入家庭的意思、
- **ATM**：Asynchronous Transfer Mode，异步传输。它是在以电话线为载体的 传统电话技术基础上扩展出来的一种通信方式。它的数据传输是以“信元”为单位来进行的，这和以包为单位传输数据的 TCP/IP 很像，但这种方式并不适用于计算机通信。
- **PPP**：Point-to-Point Protocol，点到点协议。它是电话线、ISDN 等通信线路所
  使用的一种协议，集成了用户认证、配置下发、数据压缩、加密等各种功能。
- **BGP**：Border Gateway Protocol，边界网关协议。