# 双绞线

通常顺着网线会进入局域网，而后进入互联网，这里介绍局域网中的传输情况。

网线一般分为双绞线线和光纤，互联网一般都使用光纤，因为有超远距离传输的需要，局域网通常使用双绞线。

那么首先我们了解下什么是双绞线？以及为什么需要做成双绞线。

双绞线就是两条线通过环绕的方式绞在一起，所以叫做双绞线。

那么为什么需要做成双绞线呢？这样做明显需要的材料更多啊，因为需要解决噪声问题。

使用电信号进行传输时，如果周围有金属，会发生电磁反应，从而导致信号失真，这是情况之一。

另一种情况时，传输线之间相互也会有噪音，理论上这种噪音不大，但是相互之间太近了，所以也会造成影响。

而双绞线这种特殊的环绕方式，两根线之间相互抵消内部及外部的噪声影响。

# 集线器

集线器是对以太网基本架构的忠实实现，简单来说就是集线器会连接许多机器，信号传输给集线器之后，集线器会通过广播【ARP协议】将信号传输给所有连接的机器，然后机器校验包内容，只留下和自己匹配的，其他机器丢弃包。

集线器的这种方式，导致一个机器发送信号时，其他所有机器不能再发送，否则就会发生信号碰撞，所以这种模式叫做半双工

# 交换机

交换机可以认为是集线器的升级版，我是这么理解的。

交换机和集线器一样，同时连接了多台网络设备，每台设备连接着一个交换机端口。

信号传输到交换机端口后，MAU/PHY模块会将信号转换为通用信号，然后传给MAC模块将其转换为数字信号，MAC模块会通过FCS码校验数据，没问题的话就存储到缓存区中，这一部分内容和计算机网卡的作用是相同的，可以认为交换机的接口及其电路组成的端口实质上对应着计算机的网卡部分，不过不同的是，计算机的网卡含有mac地址，而交换机端口则没有mac地址，但是它们所作的事情是一样的。

交换机会从缓存区取出数据，通过数据的mac地址部分将其转发给对应的端口，刚刚说了端口没有mac地址，但是端口必然连接着网络设备，网络设备有自己的mac地址，这就足够了。

在最开始的时候，交换机中没有mac地址表，接收到数据之后会通过广播的方式发送给所有端口，一旦有端口接收数据并响应，这个时候交换机就可以将mac地址记录，下一次发送时直接发送给对应的端口，而无需广播。

除了广播的时候可以获取mac地址，接收数据里包含发送发的mac地址，此时也会将mac地址和端口对应存存储到mac地址表上。

另外就是，如果其中某个mac地址一段时间不用，那么交换机会删除地址表的这个地址，比如说有人在公司连接了交换机，但是下班后他拔掉网线，这个时候对应的mac地址就不在响应端口了，所以需要处理掉。

可以看到，对于交换机的mac地址表，交换机会自动维护，不需要手动维护，另外说一下，如果地址表出现问题，直接重启交换机即可重置mac地址表。

关于交换机，这里说一下双全工的事情，之前说集线器是半双工模式，交换机可以实现双全工，意思是不仅是同时发送和接收，还可以一次转发多个不同的信号。

其原因在于交换机是通过电子电路实现的通信控制，可以认为有一系列控制传输的开关，通过控制开关闭合，就可以将信号从指定端口传输给另一指定端口，这一操作可以同时进行，且不会相互影响，而且这一系列开关电路是电子电路，所以切换速度极快。

另外想要实现双全工通信，必须通信双方都支持双全工，其中一方是半全工，则通信就是半全工，原本设计这个是手动设置的，不过后来发现太麻烦做成了自动调整，交换机不仅可以自动切换半全工和双全工，而且会自动调整网络速率，使其达到最佳速率。因为网络传输中，不仅支持的通信模式不同，其传输速度也会存在差异，比如一方是100MB/S，另一方是200MB/S，这个时候最理想的通信速度是100MB/S，或快或慢都会造成不同程度的问题。

# 路由器

路由器和交换机的主要不同在于，路由是对ip协议的实现，交换机是对以太网协议的实现，路由转发是以ip为基准的，交换机转发是以mac地址为基准的。

这一点根本性不同，将会导致其他不同点的产生。

从硬件上来说，路由器的每一个端口都有mac和ip地址，这是交换机不具备的，交换机只负责转发，而路由器则是转发过程中的接收和发送点。

我们知道在网络中，构成的基点并非计算机，而是host【主机】，路由器的每一个端点都是host。

以交换机的广播机制而言，交换机在不知道mac地址的时候，可以直接广播然后通过响应信息得知mac地址。交换机最多连接几千台设备，这个成本并不是很高，而路由器呢？它是基于ip进行设计的，没法这么广播。

那么问题来了，路由器是怎么基于ip进行转发的呢？

关键在于对路由表的维护，如果是交换机，维护mac地址表是其转发规则的一部分，对于路由来说，转发和路由表维护是两个分离的过程，并没有直接关系。

路由表的维护有两种方式：
1. 手动维护
2. 通过协议自动维护，比如BGP、RIP、OSPF等路由协议

我们来看一下路由器的转发过程，首先我们从ip报头信息中可以获取到目标ip地址，此时路由器有维护一份路由表，里面维护了相关ip子网或主机信息，主要字段有目标地址、子网掩码、网关、接口、跃点数，下面我说明下这些字段。

目标和子网掩码是用于匹配的，比如说`192.168.1.0/24`和`192.168.1.0/32`看起来目标地址相同，但是却是两条不同的路由，因为`192.168.1.0/24`是子网，而`192.168.1.0/32`是主机。

路由器的转发规则之一：优先选择最长匹配，因为实际上转发ip可能对应多条记录，这个时候优先匹配最长的，因为最长匹配子网的其含有的主机数量是最少的，后续查询速度更快。

如果匹配的地址相等，比如`192.168.1.10/24`和`192.168.1.20/24`，那么优先选择跃点最小的，跃点表示要跳跃到目标ip所需要转发的次数，所以跃点越小就表示转发次数越少

如果找到符合条件的目标地址，则将数据转发给对应的接口。

如果没有符合条件的会转发给网关，目标地址为`0.0.0.0/0`的就是网关，根据匹配规则，这个必然是最后才会被匹配的，如果所有的目标地址都不匹配则跳转到网关，网关记录的ip是互联网的入口。

如果在互联网也找不到，那么会通过ICMP【internet control message protocol】协议发送报错信息给请求方，同时会将请求包舍弃。

这里再补充下路由聚合，路由表假设有`10.10.1.0/24`、`10.10.2.0/24`、`10.10.3.0/24`这几个子网都需要转发给路由器A，且没有其他`10.10.0.0/16`的子网，那么此时可以将3个子网聚合成`10.10.0.0/16`，这样可以提高转发效率。

我们可以想象下，假设路由表中记录了数千或数万子网记录，通过这种方式可以使其降低一到两个数量级，会减少至数十或数百条，那么匹配会简单许多，而且也减少了对内存的消耗，可以记录更多的子网信息。这种路由聚合的做法既提高了对内存的使用效率，也提高了匹配的速度，很有用的一种策略。

另一方面，也会出现需要路由拆分的情况，比如说除了刚刚的3个地址，现在出现了`10.10.4.0/24`需要转发给路由器B，那么原来的`10.10.0.0/16`则需要进行拆分，否则会出现转发异常。

## 接口操作

现在我们将目光降低一层，当路由器匹配到转发的ip之后会转发给对应接口，但是接口怎么传给对应的机器？因为这里还有一个问题，我们知道路由器的转发目标是ip，但是我们也知道路由器ip和mac并不是绑定的，它可以换。

这里涉及到一个很有意思的点，也是ip协议最精华的一个点，是这样的，ip协议最有意思也最精彩的部分莫过于将目标抽象为通用的通信对象，它并不关注通信手段本身。

比如说我们想将一个ip传输给另一个ip，我们的通信对象是明确的，但是通信手段是可选的，比如说它可能是以太网、也可能是无线网，ip对此并不限定。

ip协议会将其委托给通信模块，通信模块是自由的，路由器可以安装多种通信模块，根据需要进行选择，假设这里路由器使用的通信方案是以太网方案，那么接口这里会将ip的信息加上mac头部，然后转换为通用信号，在根据网线转换为对应的信号传输给对应的硬件。

以以太网方案为例，路由器端口会配置相关模块进行处理，进行信号转换。

那么这里路由器接口怎么知道ip对应的硬件地址呢？这里会使用ARP协议通过广播拿到mac地址，然后按以太网协议根据mac地址进行传输即可。

这里路由器也会使用ARP缓存策略提升性能。

## TTL
另外说一下，ip报文中有个TTL字段，表示生存时间【time to live】，没经过路由器转发一次，则数值减1，为0时直接舍弃包。

这一策略是为了防止包不停打转的情况，按现在的互联网涉及，即使是将信息发送给地球的另一面，也不过几十次转发就能实现，如果一直在转发，那么肯定是异常的。通常TTL被设置为64或128

## 地址转换和包过滤
除了转发功能，路由器还有两个重要的功能：地址转换和包过滤

首先说一下地址转换，我们知道互联网中是通过ip作为标识设备的地址的，并且这个地址是唯一的，在网络发展早期每台设备想要联网都是直接分配ip的，不过问题很快就出现了，我们知道ip是32位bit组成上，理论上最多有43亿种可能，但是在日益发展的互联网时代，这个数量不够用。

然后考虑实际情况，通过公司或家庭接入网络是，很多信息只在内部网络交互，并不会和外网有所关联，基于此，新的设计方案是公司或家庭可以申请一或多个公网ip连入互联网，而公司有自己的内网，内网的ip允许重复，就是说假如有两家不同的公司，这两个公司连入公网的ip要求唯一，但是内网的ip之间这两家公司是可以重复的。

利用这个设计，互联网可支持的数量一下子增加了约`255*255*255=16581375` 1658万倍，现在足以支持数万亿甚至数十万亿的设备连接入网。

目前允许作为私网IP的频段只有以下3类：
- `10.0.0.0`、`10.255.255.255`
- `17.16.0.0`、`17.31.255.255`
- `192.168.0.0`、`192.168.255.255`

路由器具备地址转换的功能，我们先看一个问题，现在假设公司内网有数千台设备，都是通过同一个ip进行互联网通信的，那么怎么将对应的数据发送给对一个的设备呢？这就是路由器需要处理的部分。

答案其实很简单，通过端口，端口是16位bit信息，理论上支持65535个设备，就是说1个ip就足以支持数万台内网设备，所谓地址转换就是将公网地址和内网地址进行映射。

然后是包过滤，因为网络包具有mac头部、ip头部、tcp头部这些信息，所以我们可以设置一套过滤规则，不符合规则的包直接舍弃掉。

# 专题：关于设备名称
- 集线器：repeater hub
- 交换机：switching hub
- 路由器：router

# 专题：路由转发实例
| 目标地址         | 子网掩码| 网关 | 接口  | 跃点数 | 
|--------------|---| --- |---| --- |
| 10.10.1.0    | 255.255.255.0   | —— | e2  | 1 | 
| 10.10.1.101  | 255.255.255.255 | —— | e2  | 1 | 
| 192.168.1.0  | 255.255.255.0   | —— | e3  | 1 |
| 192.168.1.10 | 255.255.255.255   | —— | e3  | 1 |
| 0.0.0.0      | 0.0.0.0   | 192.0.2.1 | e1  | 1 | 