# TCP
TCP，即传输控制协议

TCP可分为：
1. 创建
2. 连接
3. 传输
4. 断开
这几个阶段

## 创建
首先是创建，这里主要是指创建套接字，我们怎么理解套接字呢？将其视作一块存放控制信息的内存空间即可，创建套接字就是申请一块存放控制信息的内存空间，比如ip地址、端口号这些

## 连接
然后是连接，刚刚创建阶段只是申请了一块内存空间，什么内容也没有，那么想传输数据也不到，所以为了传输数据，我们需要做一些准备，比如说发送方和响应方的ip地址这些字段

连接阶段就是准备这些传输所必须的控制信息，控制信息包括刚刚说的ip地址、端口号信息，主要就是TCP报头信息，这里并不展开。

然后，在之后的数据传输阶段需要存放数据的空间，这个空间称作数据缓冲区，也是在连接阶段申请的。

连接阶段TCP主要做的就是创建一个TCP包，包含TCP报头信息，此时设置SYN控制位为1，表明这是一个连接请求。

然后TCP会将创建好的TCP包委托给IP协议，ip会负责将包发送到指定服务器上，然后服务器将响应包返回，告知客户端已成功接受包，此时连接阶段完成，接下来就是一般的数据传输阶段了。

## 传输
传输阶段主要会做两件事：
1. 数据分包
2. 数据校验

数据分包是因为http包数据可能很大，而TCP包含头部信息在内最大不允许超过65536个字节，所以TCP包可能容纳不下应用层的数据，所以需要分到不同的数据包中进行传送。

关于报的校验部分，TCP使用ACK和包的长度进行校验。

首先随机得到一个初始序号，然后传递TCP包给响应方，然后响应方将 序号加上TCP包长度得到的值即为序号，TCP以此进行校验。

什么意思呢？

比如说初始序号为0，发送方发送一个数据长度为100的包给响应方，响应方接收到这个包之后，会返回响应信息，响应信息中包含当前接受的部分，比如说ack=100，表示响应方已接受到数据的第100字节，这样发送方就知道响应方接收到第一个包了，它就可以发送第二个包给对方。

ok，现在我们发送数据长度为88的第二个包给对方，如果发送失败 ，响应方一直没有响应，那么发送发会重新发送，如果多次重发依旧没有结果，则停止传输。

响应方如果接受到多个相同的包，也只会取一次，比如说多次发送数据第101-188字节，只要响应方知道自己已经接收到第188个字节，那么再之前的包它都不会接受。

> ack解决的是丢包问题，如果数据被篡改，tcp同样有校验机制，不过不是使用ack

然后刚刚这个流程是单次的，发送方需要通过响应方受到的消息来判断是否接收成功，然后发送下一个包，但这个做法有点傻，实际情况不是这样的。

发送方完全可以将多个数据包同时或者说批量发送给响应方，响应方接收到之后放到缓存区，然后根据序号依次取用即可，如果缺少某个包，那么可以发送响应信息给请求方：“喂，你第7包怎么没有，是不是丢包了，你再发一次”，那么请求方可以只重发一次丢包的数据，这样就很好了保证了传输效率。

然后关于缓冲区的大小，这个是可设定的，也正是因此，缓冲区大小设置是TCP调优的一个重要参数。

因为缓冲区大小是有限的，所以发送方也不能完全无限制的发送，否则发的再多还是会被响应方丢弃，这样不仅浪费了资源，还造成了网络通道的阻塞。

因此，数据传输中一旦响应方缓冲区满了，发送方就不会再发送包了，直到缓冲区空间又空出来。

那么请求方怎么知道响应方的缓冲区有多大呢？

在建立连接时，响应方会告诉请求方：“我缓冲区有10000个字节，你看着发”，那么请求方在发送数据时会进行计算，一旦数据超过10000个字节，就不再发送。响应方从缓冲区取数据之后，会发送响应信息给请求方，说：我这边缓冲区数据已经用了，现在缓冲区还有2000个字节空间，你可以继续发送请求了，然后请求方就可以继续发送数据了，这一次数据超过2000个字节它就不再发送了。

实际上，缓冲区很少说被撑满，更多的情况时响应方拿数据的速度超过传输的速度，基本上缓冲区空的时候比较多，这也可以想象，毕竟本地数据处理速度超过网络数据超过是很合理的。

## 断开
最后是断开阶段，第一个问题是谁负责断开？答案是谁都可以，tcp设计上允许两方中任意一个发起断开。

发起断开的做法就是将tcp头部字段的`FIN`设置为1，即表示申请断开连接。

需要注意的是，tcp断开连接并不会直接删除套接字，而是会等待一段时间后，再进行删除。

为什么要这么做呢？主要是为了防止误操作，误操作的情况有很多，这里列举一种简单场景。

假设响应方发送`FIN=1`给请求方，因为网络延迟请求方一直没收到，所以也就没返ack给响应方，响应方看对方一直没反应，以为丢包了，那它就会再发一次。

这个时候，第一个包到了，请求方收到这个信息应该断开连接，清空相关信息，但是它还不能删掉这个套接字。为什么呢？假设现在删掉了，然后这个端口被其他程序新建的套接字使用了，那么响应方的FIN=1发到，就会将新的套接字误删。

那么为什么需要等一段时间呢，因为tcp的重发机制就是没收到消息先重发个几次，重发一段时间之后还是没有响应，就认为网络有问题，不会再重发。通常来说，套接字会被保留个几分钟再删除。

# ip
tcp将封装好的TCP包交给IP协议，委托其传输，我们看一下ip做了什么？

ip首先封装出一个ip包，我们知道包的组成有两部分：头部和数据，头部是控制信息，所以需要先生成ip相关的控制信息

封装完ip包之后将其交给网卡驱动。

# 网卡驱动
目前为止，http、smtp这一类协议由应用程序进行控制

tcp、udp、ip协议在内由操作系统负责控制

而接下来的部分不再是操作系统的负责范围，由网卡负责，ip将数据将给网卡之后。

我们来看下网卡的组成：
1. 缓冲区
2. MAC模块
3. MAU/PHY
4. 网线接口

网卡将其放置到缓冲区，然后添加mac控制信息

什么是mac？mac，即Media Access Control Address，也就是俗称的物理地址，它是和网卡绑定的，存储在网卡的ROM中，我们说是和计算机通信，实际上是和网卡进行通信。

除了mac报头，mac模块还会在数据后面添加FCS码，这个码的作用简单来说就是会使用它进行校验，看包数据是否发生错误。

同时mac模块还会在头部添加起始帧分界符，稍后会介绍起始帧分界符，这里我们先看下当前包的组成：
1. 起始帧分界符
2. mac报头
3. ip报头
4. tcp报头
5. 应用层数据
6. fcs

然后从中读取数据将数字信号转换为电信号或光信号传输出去。

从响应方接收数据时，网卡的MAU模块会将电信号或光信号转换为数字信号，然后传给ip协议

这里有一个麻烦的地方，原因在于电信号没有稳定的速率，有的10MB/s，有的20MB/S，我们要怎么解析？

比如说1us的时间可以传输10个信号，也可以传输20个信号，看似是`1111100000`的信号可能是`11111111110000000000`或相反

为了正常解析信号，除了数据信号之外，我们还需要时钟信号

网卡将信号转换完成后会通过网线传输出去

# 名词
- **MAU**（Medium Attachment Unit， 介质连接单元）
- **PHY**（Physical Layer Device，物理层装置）