[TOC]

CPU主要功能：
1. 执行指令，进行运算
2. 控制外部设备，对其进行输入输出

即，CPU必须具备运算和IO能力。

外设输入需要考虑两个问题：
1. 输入可能随时发生，CPU怎么及时处理
2. CPU从哪里知道外设的输入

# 接口芯片和端口
1. 外设的输入不直接送入内存和CPU，而是送入相关的接口芯片的端口中
2. CPU向外设输入也不是直接送入外设，而是先送入端口中，由相关芯片送入外设
3. CPU还可以向外设输出控制命令，而这些控制命令也是先送入相关端口中，再由芯片根据命令对外设进行控制

# 外中断信息
针对第一个问题。

1. 当CPU外部有需要处理的事情发生时，比如外设的输入到达，相关芯片将向CPU发出中断信息
2. CPU在执行完当前指令后，可以检测到发送过来的中断信息，引发中断过程，处理外设的输入

## 分类
### 可屏蔽中断
1. 可屏蔽中断是CPU可以不响应的中断
2. 当CPU检测到可屏蔽中断信息时
   1. 如果IF=1，则CPU在执行完当前指令后响应中断，引发中断过程
   2. 如果IF=0，则不响应可屏蔽中断

设置`IF`
- `sti` 设置`IF=1`
- `cli` 设置`IF=0`

### 不可屏蔽中断
1. 不可屏蔽中断是CPU必须相应的中断
2. 当CPU检测到不可屏蔽中断信息时，在指令完当前指令后，立刻响应，引发中断过程


1. 几乎所有由外设引发的中断，都是可屏蔽中断
2. 当外设有需要处理的外设事件（比如键盘输入），相关芯片向CPU发出可屏蔽中断信息
3. 不可屏蔽中断是系统中有必须处理的紧急情况时使用的

# PC机键盘的处理过程
键盘输入
1. 键盘上每一个键相当于一个开关，键盘中有一个芯片对键盘上的每一个键的开关状态进行扫描
2. 按下键时，开关接通，该芯片就产生一个扫描码（不同的键对应不同的码）
3. 扫描码被送入主板上相关接口芯片的寄存器中，该寄存器端口是60H
4. 松开按下的键时，也产生一个扫描码，送入相关接口芯片的寄存器中，端口同样是60H

一般将按下键时产生的码叫做**通码**，松下键时产生的码叫做**断码**

扫描码1个字节，通码第7位是0，断码第7位是1，即`断码=通码+80H`

## 引发9号中断
1. 扫描码送入60H端口后，相关芯片就会向CPU发出可屏蔽中断码，中断类型码为9
2. CPU接收到信息后，如果IF=1，则中断响应，引发中断过程，执行`int9`中断例程

## `int9`中断例程
BIOS内置例程
1. 读出60H端口中的扫描码
2. 如果是字符键的扫描码，将该扫描码和它对应的字符码（即ASCII码）送入内存中的BIOS键盘缓冲区；
3. 如果是控制键（比如Ctrl）或切换键（比如CapsLock）的扫描码，则将其转变为状态字节（用二进制位记录字节）写入内存中存储状态字节的单元
4. 对键盘系统进行相关的控制，比如说，相关芯片发出应答信息


1. BIOS键盘缓冲区是系统启动后，BIOS用于存放`int9`中断例程所接收的 键盘输入 的内存区。
2. 该内存区可以存储15个键盘输入
3. 因为`int9`中断例程除了接收扫描码外，还要产生和扫描码对应的字符码，所以在BIOS键盘缓冲区，一个键盘输入用1个字存储，高位字节存放扫描码，低位字节存放字符码

0040:17单元存储键盘状态字节，每个位对应的状态信息如下：
1. `0` 右`shift`状态，置`1`表示按下右`shift`
1. `1` 左`shift`状态，置`1`表示按下左`shift`
1. `2` `Ctrl`状态，置`1`表示按下`Ctrl`
1. `3` `Alt`状态，置`1`表示按下`Alt`
1. `4` `ScrollLock`状态，置`1`表示`scroll`指示灯亮
1. `5` `NumberLock`状态，置`1`表示小键盘输入的是数字
1. `6` `CapsLock`状态，置`1`表示输入大写字母
1. `7` `Insert`状态，置`1`表示按下处于插入状态