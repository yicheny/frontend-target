[TOC]

# 机械硬盘
硬盘由电路和盘体组成，说一下盘体组成

1. 串行接口：连接计算机设备，数据交互+提供电源
2. 空气过滤片：保证腔体内无尘。这里可以想一想，如果想更绝对的保证无尘环境，直接封闭就可以了，为什么要加空气过滤片呢？答案是散热，电能转换为机械能驱动主轴高速运转，会释放热量，所以需要保留散热能力，因此必须与外部连通，我们在硬盘可以看到对应的呼吸腔口，但是直接连通又会破坏内部无尘环境，所以又加了空气过滤片。
3. 磁盘：在合金或玻璃基底上覆盖一层磁性结构，通过读取或修改磁性物质状态来记录数据
4. 主轴：驱动磁片旋转
5. 磁头：用于读写数据
    - 读：磁盘表面磁场会使得磁头产生相应的感应电流，经相关电路处理后可以还原成数据
    - 写：磁头发出相应电流改变盘面磁性物质状态，在磁头离开状态依旧保持，则数据就被记录下来了
6. 音圈马达： 磁头的旋转是通过音圈马达控制的，音圈马达是无刷电机，具有磨损小、发热低、精准高等特定，适合长时间高精度工作
7. 磁头停泊区
    - 磁头是音圈马达控制的，如果断电则磁头不再受控，那么这个时候磁头就会粘连到盘片上，磁头和盘面都是非常精细的零件，直接接触会妨碍盘片旋转以及造成两者损伤，所以需要想办法解决这个问题。
    - 有两种方案，一个是在盘面内粗做一个环形停泊区，磁头不工作是放在这里，为了便于停放，这个区域有意加大了粗糙度，但是这样同时也会导致硬盘启动和停止是会与盘面发生较大的摩擦进而造成损伤，所以使用这种方式的磁盘会有启停次数指标
    - 另一个方案，是在盘片放设置一个专门的停泊区，这样磁头无论工作与否都不会与盘面有接触，同时也不存在启停次数的问题。但是，我们刚刚说了，磁头不是电力驱动的，它是怎么做到磁头在停止工作时可以稳定停在磁盘架上呢？这就和永磁体有关了。
8. 永磁铁：保证磁性稳定。刚刚说了，一旦断电，磁头就会失去控制，而这个时候永磁铁就发挥作用了，磁头会在永磁铁的作用力在回到磁盘架上，解决断电时磁头和磁盘磨损的问题

## 分割单位
- 扇区：记录数据的最小单位，一般是512B，不过现在也有4K的
- 磁道：扇区环绕一圈所组成的环路，从一百多k到三百多k不等，磁道宽度取决于磁头大小，理论上磁头越小，可容纳磁道就越多，在磁性结构不变的情况下，则可记录的数据量就越大
- 柱面：一个硬盘通常由多个磁片组成，磁片正反两面都可以记录数据
- 盘面：不会以盘面进行分区
- 盘片：不会以盘片进行分区

# 分区格式
主要分为MBR和GPT两种

## MBR
MBR主要特点在于第一个扇区用于放置引导程序和分区表，扇区不小于512B，其中前446个字节用于放置引导程序，其后64个字节放置分区表

分区表用于记录分区，每个分区记录起始与结束分区序号，所以一共可以记录4个分区。

分区表记录的分区是主要分区和扩展分区，需要注意扩展分区最多有一个。

首先说一下为什么需要扩展分区，我们知道分区的最小单位是柱面（扇区组成的圆就是磁道，所有磁片的同一磁道就是柱面）

然后我们知道根据柱面我们可以在分区表中进行划分，但是这样一来就有了一个限制，我们最多只能分4个区。

所以就有了扩展分区，扩展分区可以再进行分区，比如说限制有序号为1-400的磁盘，我们可以将1-100分为主要分区1，而101-400划分为扩展分区，然后在内部再次进行分区，这叫做**逻辑分区**，和MBR一样，扩展分区会划分一部分数据区记录分区表，这样扩展分区可以分出更多的区域。

现在考虑一个问题，为什么我们需要分区？
1. 安全，一旦其中某个分区出问题，处理不会影响到其他分区
2. 性能，划分之后查询效率更高

关于分区，我个人不喜欢使用主要分区，我自己的想法是更多的使用扩展分区，因为有一个好处，可以动态调整，比如说某个逻辑分区不够用或者太大，是可以调整的，而如果我们同时使用了主要分区和逻辑分区，则不能动态调整，动态调整的前提是分区是扩展分区。

实际上，可以认为分区就是对分区表做调整。

### MBR的缺陷
1. 引导程序区块太小，放不下较复杂的程序
2. 只有一个管理区块，一旦毁坏很难修复
3. 无法使用2.2T以上的磁盘容量

#### 为什么MBR无法使用2.2T以上的磁盘容量
这个问题一直困扰着我许久，因为刚刚说了一个分区表可以使用16个字节，我想的比较简单，8个字节记录起始扇区号，8个字节记录结束扇区号，1个字节是8bit，那么应该最大可以支持2^64*512B大小的空间，应该远超2.2T才对。

实际上并不是这样，我查阅资料之后发现分区表记录的信息很多，留给记录起始和结束扇区号只有4字节，这样最大可以支持2^32*512B的空间，约等于2T

> 注：512B为默认标准扇区大小

MBR分区表详细结构：

![MBR分区表详细结构](https://img-blog.csdnimg.cn/img_convert/35c28f3db7d3565ae1d7d1280da94b30.gif)

## GPT
![GPT-管理扇区](https://pic.imgdb.cn/item/629f18b60947543129af8614.jpg)

划分单位是LBA，以前默认扇区大小是512B，但是随着时代发展，扇区大小有了变化，处理512B大小的扇区，还有4k扇区存在，所以为了标准化，LBA的区块大小就是512B，忽略物理扇区的规格不同。

GPT共使用了68个LBA进行分区管理，其中34个扇区是备份。

LBA0是引导程序扇区，同样前446字节是放置引导程序，而原分区表区块只放置标识符，用于标识是GPT格式。

LBA1是管理分区表的数据区，LBA2-LBA33是实际分区表记录区别，LBA1是记录分区表区块位置和大小的区块，同时也记录了对应备份区块的位置以及校验码，如果校验码不匹配，则会使用备份区块对分区表进行恢复。

LBA2-LBA33区块，用于记录分区的区块，每个LBA记录4组分区数据，512/4=128，即1组分区数据可以使用128字节记录，相比MBR的16字节有了巨大提升，在GPT中分包分配了8字节的大小用于记录扇区起始和结束位置，所以实际可以支持2^64*512B空间，约等于2^30TB容量，差不多10亿TB这样。

另外值得一提的是，在GPT分区中不分主要分区、扩展分区、逻辑分区，所有分区都是主要分区

# 启动程序
- BIOS
- UEFI

## BIOS
基本输入输出系统，使用汇编编写，BIOS会读取指定地址的指令，就是磁盘引导扇区代码。

其代码主要目的就是供用户选择合适的内核代码，因为实际上一个磁盘是可以安装多个内核的，可以有多重引导。

默认主引导扇区有引导代码，然而实际上每个分区都有自己的引导扇区，引导扇区可以指向对应的内核，所以一份磁盘中可以有多份操作系统，引导扇区代码可以让我们选择其中一份进行启动。

## UEFI
相比于BIOS，更安全、启动速度更快、更容易移植、开发更简单。

具体细节暂略

# 目录树
Linux相比Windows分区特殊的地方在于，Windows是通过盘符进行分区的，而Linux则是将磁盘**挂载**到对应目录下，所有文件及目录都源于根目录`/`从而组成一个目录树

# 名词
- MBR：Master Boot Record 
- GPT：GUID Partition Table
- LBA：Logical Block Address

# 参考资料
- [MBR分区表为什么最大只能识别2TB硬盘容量](https://blog.csdn.net/liuxiao723846/article/details/120013643)