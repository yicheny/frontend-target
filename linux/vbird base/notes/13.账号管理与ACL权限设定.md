[TOC]

# 用户登陆
0. 输入账号密码
1. 查找`/etc/passwd`里是否有输入账号
   1. 没有则跳出
   2. 有则将账号对应的UID和GID读出，同时将该账号的`HOME`目录和`shell`配置一起读出
2. 查找`/etc/shadow`找出对应的账号和UID，然后核对输入的密码和记录的密码是否一致
3. 如果一切顺利，则进入`Shell`进程

## `/etc/passwd`
1. 这个文件每一行都代表一个账号
2. 里面账号并不都是用户账号，很多都是系统正常所需要的（我们简称为**系统账号**），比如`bin`、`daemon`、`adm`等等

```shell
[yyy@localhost ~]$ head -n 4 /etc/passwd
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
```
每个linux的第一行都是`root`账号，我们看一下`root`这行，通过`:`将内容划分为7栏
1. 账号名称
2. 密码：早期unix系统的密码是放在这个栏位上的，但是因为这个文件特性是所有程序都能读取，所以很容易造成密码泄露，因此现在这个栏位都是`x`，密码被单独放置到`/etc/shadow`文件里了
3. UID：使用者识别码
  - `0` 系统管理员
  - `1~999` 系统账号
    - `1-200` 系统自建的系统账号
    - `201-999` 使用者有系统账号需求时，可以使用的UID
  - `1000-60000` 可登入账号
4. GID：群组识别码，和`/etc/group`有关，`/etc/group`和`/etc/passwd`类似，是用来识别群组的
5. 使用者信息说明：一般没啥用，有需要时可以在这里提供信息
6. `home`目录：使用者家目录，登陆后初始目录就在家目录
7. `shell`：登入后会取得一个`shell`和系统内核进行沟通，完成操作任务

## `/etc/shadow`
```shell
[root@localhost ~]# head -n 4 /etc/shadow
root:$1$zdPX/cUD$9drz2mw5bx7zan4C952je0::0:99999:7:::
bin:*:18353:0:99999:7:::
daemon:*:18353:0:99999:7:::
adm:*:18353:0:99999:7:::
```
同样是以`:`作为分隔符，我们看一下内容：
1. 账号名称
2. 密码：经过加密后的密码
3. 最近修改密码日期：从1971年1月1日到修改为止的天数
4. 密码不可被变动天数
5. 密码需要重新变更天数
6. 密码需要变更期限前的警告天数
7. 密码过期后的账号宽限天书（密码过期日）：过期的账号可以登入和操作，但是会有重新设定密码的提示，设置0则过期时立刻失效，设置-1则永不失效
8. 账号失效日期：失效的账号无法使用
9. 保留：最后一栏是保留的，以后可能有新功能加入

### 密码失效-一般用户
通过`root`账号重新设定即可，不需要知道旧密码

### 密码失效-root
可以使用改革中可行的方法关机进入`linux`再修改，比如
1. 重新关机进入单人维护模式，系统会主动给与拥有`root`权限的`bash`界面，此时通过`passwd`指令修改密码即可
2. 以`Live CD`开机后挂载根目录去修改`/etc/shadow`，将`root`的秘密栏清空，这样就可以不用密码登陆，不过记得登陆后重新设定密码

## `/etc/group`
```shell
[root@localhost ~]# head -n 4 /etc/group
root:x:0:
bin:x:1:
daemon:x:2:
sys:x:3:
```
1. 群组名称
2. 群组密码：通常不用设定，这个是给群组管理员使用的，管理员叶很少设。同样的，密码移动到`/etc/gshadow`，所以这里是`x`
3. GID
4. 群组支援的账号名称：一个账号可以加入多个群组，某个账号想要加入这个群组时，将该账号填写此栏（因为GID只能设定一个，如果需要加入更多群组，就可以使用这种方式）。比如说，我想让`yyy`、`xyy`加入`root`这个群组，那么这一行改成`root:x:0:yyy,xyy`即可

加入群组的方法：
- 由系统管理员通过`usermod`拉入
- 如果群组由设定群组管理员，可以让群组管理员通过`gpasswd`拉入

有一个问题：我们发现通过群组支援账号栏，一个用户可以加入多个群组，那么实际上会拥有哪个群组的权限？如果建立新文件其`group`是哪个？

### 有效群组和初始群组
通过`groups`我们可以查看所有用户加入的群组，简单的说，只要用户加入了对应群组，那么相应群组的权限该用户都有。
```shell
[yyy@localhost root]$ groups
yyy yStudy yStudy2
```

注意`groups`返回的第一个群组，它叫做**有效群组**，如果我们建立文件则默认使用此群组，一般而言登陆账号对应的`GID`群组就是有效群组【这个也叫做初始群组】，在登陆账号内第4栏记载的`GID`就是初始群组的`GID`，初始登入是会将初始群组设为有效群组。

我们可以使用`newgrp`切换有效群组：
```shell
[yyy@localhost root]$ newgrp yStudy
[yyy@localhost root]$ groups
yStudy yyy yStudy2
```

需要注意的是`newgrp`实际上是新开了一个`bash shell`。

## `/etc/gshadow`
```shell
[root@localhost ~]# head -n 4 /etc/gshadow
root:::
bin:::
daemon:::
sys:::
```
1. 群组名称
2. 密码
3. 群组管理员账号（与`gpasswd`有关）
4. 有加入该群组支援的所属账号

# 账号管理
## `useradd`
```shell
useradd [-u UID] [-g 初始群组] [-G 支援群组] [-mM] \
> [-c 说明栏] [-d 家目录绝对路径] [-s shell] 使用者账号名
```
参数：
- `-u` 设置UID
- `-g` 初始群组
- `-G` 支援群组
- `-M` 强制！不要建立使用者家目录【系统账号预设值】--账号建立时一般情况下会自动创建家目录，默认是`/home/账号名`，这里的意思就是如果是系统账号则不建立家目录
- `-m` 强制！要建立使用者家目录【一般账号预设值】
- `-c` 就是`etc/passwd`的说明内容，可任意内容
- `-d` 指定某个目录成为家目录，而不使用预设值，务必使用绝对路径
- `-D` 查看预设值
- `-r` 建立账号为系统账号
- `-s` 指定`bash`
- `-e` 账号失效日，格式为`YYYY-MM-DD`，
- `-f` 密码过期日

一般我们只需要使用`useradd 账号`就可以了，因为命令帮我们预设内容，所以一般不用主动设置参数。以下是预设处理的内容：
1. `/etc/passwd` 建立账号相关的资料
2. `/etc/shadow` 建立账号相关的资料【但是此时没有密码】
3. `/etc/group` 建立账号相关的资料
4. `/home`目录下建立一个与账号同名的目录作为使用者的家目录，权限为700

### 查看预设值
```shell
[root@localhost ~]# useradd -D
GROUP=100 #预设的群组
HOME=/home #预设的家目录所在目录
INACTIVE=-1 #密码过期日
EXPIRE= #账号失效日
SHELL=/bin/bash #预设的Shell
SKEL=/etc/skel #使用者家目录的内容资料参考目录
CREATE_MAIL_SPOOL=yes #是否主动帮使用者建立邮件信箱
```
这些设定就保存在`/etc/default/useradd`文件中，可以通过`cat`等命令查看

### 其他读取的文档
- `/etc/login.defs`
- `/etc/skel/*`

## `passwd`
```shell
# 方式1
passwd [--stdin] [账号名称]
# 方式2
passwd [-l] [-u] [--stdin] [-S] \
> [-n 日数] [-x 日数] [-w 日数] [-i 日数] 账号
```
参数：
- `--stdin` 将通过管线传递的输出 作为密码输入
- `-l` 即`Lock`，让密码失效【会在`/etc/shadow`第二栏前加上`!`】
- `-u` 即`Unlock`，解锁密码
- `-S` 展示对应账号的密码信息
- `-n` 不可修改密码的天数
- `-x` 必须修改密码的天数
- `-w` 密码过期前的警告天数
- `-i` 密码过期日

```shell
# 1. 为当前账号修改密码
passwd 

# 2. 为指定账号修改密码
passwd yyy

# 3. 通过管道设置密码
echo "abc123" | passwd --stdin yyy2
```

## `chage`
```shell
chage [-ldEImMW] 账号名
```
参数：
- `-l` 列出该账号的详细密码参数
- `-d` 修改**最近一次修改密码的日期**，格式YYYY-MM-DD
- `-E` 修改**账号失效日**，格式YYYY-MM-DD
- `-I` 修改**密码失效日**（密码过期日）
- `-m` 修改**密码不可变动天数**
- `-M` 修改**密码需要变动天数**
- `-W` 修改**密码过期前警告日期**