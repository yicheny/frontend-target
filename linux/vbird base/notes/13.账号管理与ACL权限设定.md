[TOC]

# 用户登陆
0. 输入账号密码
1. 查找`/etc/passwd`里是否有输入账号
   1. 没有则跳出
   2. 有则将账号对应的UID和GID读出，同时将该账号的`HOME`目录和`shell`配置一起读出
2. 查找`/etc/shadow`找出对应的账号和UID，然后核对输入的密码和记录的密码是否一致
3. 如果一切顺利，则进入`Shell`进程

## `/etc/passwd`
1. 这个文件每一行都代表一个账号
2. 里面账号并不都是用户账号，很多都是系统正常所需要的（我们简称为**系统账号**），比如`bin`、`daemon`、`adm`等等

```shell
[yyy@localhost ~]$ head -n 4 /etc/passwd
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
```
每个linux的第一行都是`root`账号，我们看一下`root`这行，通过`:`将内容划分为7栏
1. 账号名称
2. 密码：早期unix系统的密码是放在这个栏位上的，但是因为这个文件特性是所有程序都能读取，所以很容易造成密码泄露，因此现在这个栏位都是`x`，密码被单独放置到`/etc/shadow`文件里了
3. UID：使用者识别码
  - `0` 系统管理员
  - `1~999` 系统账号
    - `1-200` 系统自建的系统账号
    - `201-999` 使用者有系统账号需求时，可以使用的UID
  - `1000-60000` 可登入账号
4. GID：群组识别码，和`/etc/group`有关，`/etc/group`和`/etc/passwd`类似，是用来识别群组的
5. 使用者信息说明：一般没啥用，有需要时可以在这里提供信息
6. `home`目录：使用者家目录，登陆后初始目录就在家目录
7. `shell`：登入后会取得一个`shell`和系统内核进行沟通，完成操作任务

## `/etc/shadow`
```shell
[root@localhost ~]# head -n 4 /etc/shadow
root:$1$zdPX/cUD$9drz2mw5bx7zan4C952je0::0:99999:7:::
bin:*:18353:0:99999:7:::
daemon:*:18353:0:99999:7:::
adm:*:18353:0:99999:7:::
```
同样是以`:`作为分隔符，我们看一下内容：
1. 账号名称
2. 密码：经过加密后的密码
3. 最近修改密码日期：从1971年1月1日到修改为止的天数
4. 密码不可被变动天数
5. 密码需要重新变更天数
6. 密码需要变更期限前的警告天数
7. 密码过期后的账号宽限天书（密码过期日）：过期的账号可以登入和操作，但是会有重新设定密码的提示，设置0则过期时立刻失效，设置-1则永不失效
8. 账号失效日期：失效的账号无法使用
9. 保留：最后一栏是保留的，以后可能有新功能加入

### 密码失效-一般用户
通过`root`账号重新设定即可，不需要知道旧密码

### 密码失效-root
可以使用改革中可行的方法关机进入`linux`再修改，比如
1. 重新关机进入单人维护模式，系统会主动给与拥有`root`权限的`bash`界面，此时通过`passwd`指令修改密码即可
2. 以`Live CD`开机后挂载根目录去修改`/etc/shadow`，将`root`的秘密栏清空，这样就可以不用密码登陆，不过记得登陆后重新设定密码

## `/etc/group`
```shell
[root@localhost ~]# head -n 4 /etc/group
root:x:0:
bin:x:1:
daemon:x:2:
sys:x:3:
```
1. 群组名称
2. 群组密码：通常不用设定，这个是给群组管理员使用的，管理员叶很少设。同样的，密码移动到`/etc/gshadow`，所以这里是`x`
3. GID
4. 群组支援的账号名称：一个账号可以加入多个群组，某个账号想要加入这个群组时，将该账号填写此栏（因为GID只能设定一个，如果需要加入更多群组，就可以使用这种方式）。比如说，我想让`yyy`、`xyy`加入`root`这个群组，那么这一行改成`root:x:0:yyy,xyy`即可

加入群组的方法：
- 由系统管理员通过`usermod`拉入
- 如果群组由设定群组管理员，可以让群组管理员通过`gpasswd`拉入

有一个问题：我们发现通过群组支援账号栏，一个用户可以加入多个群组，那么实际上会拥有哪个群组的权限？如果建立新文件其`group`是哪个？

### 有效群组和初始群组
通过`groups`我们可以查看所有用户加入的群组，简单的说，只要用户加入了对应群组，那么相应群组的权限该用户都有。
```shell
[yyy@localhost root]$ groups
yyy yStudy yStudy2
```

注意`groups`返回的第一个群组，它叫做**有效群组**，如果我们建立文件则默认使用此群组，一般而言登陆账号对应的`GID`群组就是有效群组【这个也叫做初始群组】，在登陆账号内第4栏记载的`GID`就是初始群组的`GID`，初始登入是会将初始群组设为有效群组。

我们可以使用`newgrp`切换有效群组：
```shell
[yyy@localhost root]$ newgrp yStudy
[yyy@localhost root]$ groups
yStudy yyy yStudy2
```

需要注意的是`newgrp`实际上是新开了一个`bash shell`。

## `/etc/gshadow`
```shell
[root@localhost ~]# head -n 4 /etc/gshadow
root:::
bin:::
daemon:::
sys:::
```
1. 群组名称
2. 密码
3. 群组管理员账号（与`gpasswd`有关）
4. 有加入该群组支援的所属账号

# 账号管理
## `useradd`
```shell
useradd [-u UID] [-g 初始群组] [-G 支援群组] [-mM] \
> [-c 说明栏] [-d 家目录绝对路径] [-s shell] 使用者账号名
```
参数：
- `-u` 设置UID
- `-g` 初始群组
- `-G` 支援群组
- `-M` 强制！不要建立使用者家目录【系统账号预设值】--账号建立时一般情况下会自动创建家目录，默认是`/home/账号名`，这里的意思就是如果是系统账号则不建立家目录
- `-m` 强制！要建立使用者家目录【一般账号预设值】
- `-c` 就是`etc/passwd`的说明内容，可任意内容
- `-d` 指定某个目录成为家目录，而不使用预设值，务必使用绝对路径
- `-D` 查看预设值
- `-r` 建立账号为系统账号
- `-s` 指定`bash`
- `-e` 账号失效日，格式为`YYYY-MM-DD`，
- `-f` 密码过期日

一般我们只需要使用`useradd 账号`就可以了，因为命令帮我们预设内容，所以一般不用主动设置参数。以下是预设处理的内容：
1. `/etc/passwd` 建立账号相关的资料
2. `/etc/shadow` 建立账号相关的资料【但是此时没有密码】
3. `/etc/group` 建立账号相关的资料
4. `/home`目录下建立一个与账号同名的目录作为使用者的家目录，权限为700

### 查看预设值
```shell
[root@localhost ~]# useradd -D
GROUP=100 #预设的群组
HOME=/home #预设的家目录所在目录
INACTIVE=-1 #密码过期日
EXPIRE= #账号失效日
SHELL=/bin/bash #预设的Shell
SKEL=/etc/skel #使用者家目录的内容资料参考目录
CREATE_MAIL_SPOOL=yes #是否主动帮使用者建立邮件信箱
```
这些设定就保存在`/etc/default/useradd`文件中，可以通过`cat`等命令查看

### 其他读取的文档
- `/etc/login.defs`
- `/etc/skel/*`

## `passwd`
```shell
# 方式1
passwd [--stdin] [账号名称]
# 方式2
passwd [-l] [-u] [--stdin] [-S] \
> [-n 日数] [-x 日数] [-w 日数] [-i 日数] 账号
```
参数：
- `--stdin` 将通过管线传递的输出 作为密码输入
- `-l` 即`Lock`，让密码失效【会在`/etc/shadow`第二栏前加上`!`】
- `-u` 即`Unlock`，解锁密码
- `-S` 展示对应账号的密码信息
- `-n` 不可修改密码的天数
- `-x` 必须修改密码的天数
- `-w` 密码过期前的警告天数
- `-i` 密码过期日

```shell
# 1. 为当前账号修改密码
passwd 

# 2. 为指定账号修改密码
passwd yyy

# 3. 通过管道设置密码
echo "abc123" | passwd --stdin yyy2
```

## `chage`
```shell
chage [-ldEImMW] 账号名
```
参数：
- `-l` 列出该账号的详细密码参数
- `-d` 修改**最近一次修改密码的日期**，格式YYYY-MM-DD
- `-E` 修改**账号失效日**，格式YYYY-MM-DD
- `-I` 修改**密码失效日**（密码过期日）
- `-m` 修改**密码不可变动天数**
- `-M` 修改**密码需要变动天数**
- `-W` 修改**密码过期前警告日期**

## `usermod`
```shell
usermod [-cdegGlsuLU] username
```
参数：
- `-c` 后接说明，对应`/etc/passwd`第5栏
- `-d` 修改账号家目录
- `-e` 修改账号失效日，格式YYYY-MM-DD
- `-f` 修改密码过期日，接天数
- `-g` 修改初始群组
- `-G` 修改支援群组
- `-a` 与`-G`合用，增加支援群组
- `-l` 修改账号名称
- `-s` 修改`shell`
- `-u` 修改`UID`
- `-L` 将使用者密码锁定，使其无法登陆
- `-U` 解锁密码

## `userdel`
删除使用者相关资料，使用者相关资料涉及：
- 账号&密码相关：`/etc/passwd`、`/etc/shadow`
- 群组相关：`/etc/group`、`/etc/gshadow`
- 个人档案：`/home/username`、`/var/spool/mail/username`

```shell
userdel [-r] username
```
参数：
- `-r` 将使用者家目录一起删除

# 使用者
刚刚介绍的指令`useradd/usermod/userdel`，都是系统管理员才能使用的，如果是一般使用者，除了密码之外，还能修改其他资料吗？

答案是可以，这里介绍一系列相关指令

## `id`
```shell
id [username]
```
用于查询账号信息

示例：
```shell
# 1. 查询和自己相关的信息
[root@localhost ~]# id
uid=0(root) git=0(root) groups=0(root) context=unconfined_u:unconfined_t:s0-s0;c0.c1023

# 2. 查询指定账号信息
[root@localhost ~]# id yyy
uid=1000(yyy) gid=1000(yyy) groups=1000(yyy),1001(yStudy),1002(yStudy2) 
```

## `finger`
这个指令现在不再内置，需要先下载第三方包：
```shell
yum install finger* -y
```

用法：
```shell
finger [-s] username
```
参数：
- `-s` 列出使用者的账号、全名、终端机代号、登入时间等等 

示例：
```shell
[root@localhost tmp]# finger yyy
Login: yyy            			Name: yyy
Directory: /home/yyy                	Shell: /bin/bash
On since Wed Jun  8 19:32 (PDT) on tty2    38 minutes 9 seconds idle
Last login Thu Jun  9 02:17 (PDT) on pts/0
No mail.
No Plan.
```
信息说明：
- `Login` 登陆者账号 `/etc/passwd`第一栏
- `Name` 全名 `/etc/passwd`第五栏
- `Directory` 家目录
- `Shell` 使用的`Shell`程序位置
- `On since …… Last login ……` 登入记录
- `No mail` `/var/spool/mail`中的信箱资料
- `No Paln` `~账号/.plan`的文件内容

关于`~账号/.plan`的内容：
```shell
[root@localhost ~]# echo "I will study Linux during this year." > ~/.plan
[root@localhost ~]# finger root
Login: root           			Name: root
Directory: /root                    	Shell: /bin/bash
On since Thu Jun  9 19:37 (PDT) on :0 from :0 (messages off)
On since Thu Jun  9 19:38 (PDT) on pts/1 from :0
   1 second idle
On since Thu Jun  9 19:25 (PDT) on tty3    4 hours 20 minutes idle
No mail.
Plan:
I will study Linux during this year.
```

查询当前账户：
```shell
[root@localhost ~]# finger
Login     Name       Tty      Idle  Login Time   Office     Office Phone   Host
root      root      *:0             Jun  9 19:37                           (:0)
root      root       pts/1          Jun  9 19:38                           (:0)
root      root       tty3     4:23  Jun  9 19:25           
yyy       yyy        tty2       47  Jun  8 19:32         
```

## `chfn`
用法
```shell
chfn [-foph] [账号]
```
参数：
- `-f` 设置全名
- `-o` 设置办公室房间号
- `-p` 办公室电话号码
- `-h` 家庭电话号码

示例
```shell
# 设置信息
[root@localhost ~]# chfn
Changing finger information for root.
Name [root]: 全名
Office []: 办公室号码
Office Phone []: 办公室电话
Home Phone []: 家庭电话

Finger information changed.

# 查看信息--在第5栏，以","隔开
[root@localhost ~]# grep root /etc/passwd
root:x:0:0:全名,办公室号码,办公室电话,家庭电话:/root:/bin/bash
operator:x:11:0:operator:/root:/sbin/nologin
```

## `chsh`
`change shell`缩写

```shell
chsh [-ls]
```
- `-l` 列出目前系统上可用的`shell`，其实就是`/etc/shells`的内容
- `-s` 修改使用的`shell`

注意`chfn`和`chsh`，都可以让一般用户修改`/etc/passwd`这个系统文件，所以这两个文件的权限都设置了`SUID`

# 群组
## `groupadd`
```shell
groupadd [-g gid] [-r] 群组名称
```
参数
- `-g` 设置`GID`
- `-r` 建立系统群组，与`/etc/login.defs`内的`GID_MIN`有关

问题：什么是私有群组？什么是系统群组？

示例
```shell
# 新建群组
groupadd group1
# 查看变化
grep group1 /etc/group /etc/gshadow
```

## `groupmod`
```shell
groupmod [-g gid] [-n group_name] 群组名
```
参数
- `-g` 设置`GID`
- `-n` 修改既有的群组名称

```shell
groupmod -g 201 -n mygroup group1
grep mygroup /etc/group /etc/gshadow
```
不推荐随意更动GID，容易造成系统资源错乱

## `groupdel`
```shell
groupdel [groupname]
```

## `gpasswd`
群组管理员功能

系统管理员`root`可以进行的操作
```shell
gpasswd groupname
gpasswd [-A user1,...] [-M user3,...] groupname
gpasswd [-rR] groupname
```
参数：
- 没有任何参数，表示设置密码
- `-A` 设置群组管理员
- `-M` 将账号加入这个群组
- `-r` 移除`groupname`密码
- `-R` 让`groupname`密码失效

群组管理员的操作：
```shell
gpasswd [-ad] user groupname
```
参数：
- `-a` 将使用者加入群组
- `-d` 将使用者移除群组

示例：
```shell
# 范例1
[root@localhost ~]# groupadd testgroup
[root@localhost ~]# gpasswd testgroup
Changing the password for group testgroup
New Password: 
Re-enter new password: 
[root@localhost ~]# gpasswd -A yyy testgroup
[root@localhost ~]# grep testgroup /etc/group /etc/gshadow
/etc/group:testgroup:x:1005:
/etc/gshadow:testgroup:$1$Y8oc1/Jh$TBVYH6Bfs5ULfyG4eZvz9.:yyy:

# 范例2
[yyy@localhost root]$ id yyy2
uid=1001(yyy2) gid=1004(yyy2) 组=1004(yyy2),1005(testgroup)
[yyy@localhost root]$ gpasswd -a yyy2 testgroup
正在将用户“yyy2”加入到“testgroup”组中
[yyy@localhost root]$ gpasswd -a yyy3 testgroup
正在将用户“yyy3”加入到“testgroup”组中
[yyy@localhost root]$ grep testgroup /etc/group
testgroup:x:1005:yyy2,yyy3
```

# 账号管理实例
## 任务1
通过指令，完成以下账号资料：

| 账号      | 全名         | 支援次要群组  | 是否可登入主机 | 密码 |
|---------|------------|---------|---------| --- |
| myuser1 | 1st user   | mygroup1 | 可以      | password |
| myuser2 | 2nd user   | mygroup1 | 可以      | password |
| myuser3 | 3rd stuser | 无       | 不可以     | password |

```shell
# 将账号拉入群组
groupadd mygroup1
useradd -G mygroup1 -c "1st user" myuser1
useradd -G mygroup1 -c "2nd user" myuser2
useradd -c "3rd user" -s /sbin/nologin myuser3

# 处理密码等相关资料
echo "password" | passwd --stdin myuser1
echo "password" | passwd --stdin myuser2
echo "password" | passwd --stdin myuser3
```